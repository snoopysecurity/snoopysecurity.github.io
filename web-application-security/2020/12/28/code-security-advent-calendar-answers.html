<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Code Security Advent Calendar 2020 Answers</title>
  <meta name="description" content="SonarSource is a company focused on code quality and static analysis.  This year, SonarSource, along with RIPS Technologies will be tweeting code challenges ...">
  
  <meta name="author" content="Sam Sanoop">
  <meta name="copyright" content="&copy; Sam Sanoop 2021">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="SonarSource is a company focused on code quality and static analysis.  This year, SonarSource, along with RIPS Technologies will be tweeting code challenges ..." />
  <meta property="og:url" content="http://snoopysecurity.github.io" />
  <meta property="og:site_name" content="ðŸ’» | Blog" />
  <meta property="og:title" content="Code Security Advent Calendar 2020 Answers" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://snoopysecurity.github.io/assets/logo-sonarsource.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Code Security Advent Calendar 2020 Answers">
  <meta name="twitter:description" content="SonarSource is a company focused on code quality and static analysis.  This year, SonarSource, along with RIPS Technologies will be tweeting code challenges ...">
  <meta name="twitter:image" content="http://snoopysecurity.github.io/assets/logo-sonarsource.png">
  <meta name="twitter:url" content="http://snoopysecurity.github.io">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://snoopysecurity.github.io/web-application-security/2020/12/28/code-security-advent-calendar-answers.html">
  <link rel="alternate" type="application/rss+xml" title="ðŸ’» | Blog" href="http://snoopysecurity.github.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="ðŸ’» | Blog">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
          <li class="nav-link"><a href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <li class="nav-link"><a href="/posts/">Posts</a>
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container has-cover" style="background-image: url(/assets/logo-sonarsource.png);">
  <div class="scrim has-cover">
    <header class="post-header">
      <h1 class="title">Code Security Advent Calendar 2020 Answers</h1>
      <p class="info">by <strong>snoopysecurity</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">



<section class="post-meta">
  <div class="post-date">December 28, 2020</div>
  <div class="post-categories">
  in 
    
    <a href="/category/web-application-security">Web-application-security</a>
    
  
  </div>
</section>

<article class="post-content">
  <p>SonarSource is a company focused on code quality and static analysis.  This year, SonarSource, along with RIPS Technologies will be tweeting code challenges from real world vulnerabilities on their twitter <a href="https://twitter.com/SonarSource">@SonarSource</a>.More information regarding this can be seen here: <a href="https://blog.sonarsource.com/code-security-advent-calendar-2020/">https://blog.sonarsource.com/code-security-advent-calendar-2020/</a>.</p>

<p>This blog post will go through some of the solutions. Note: this might be wrong from the intended solution given by SonarSource</p>

<h3 id="challenge-1httpstwittercomsonarsourcestatus1333803048599121921"><a href="https://twitter.com/SonarSource/status/1333803048599121921">Challenge 1</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>from django.contrib import auth, messages
from django.http import HttpResponseRedirect
from django.shortcuts import redirect, render
from django.utils.translation import ugettext as _
from django.views.generic import CreateView, FormView, RedirectView


class RegisterView(CreateView):
    model = User
    form_class = RegistrationForm
    template_name = "register.html"
    success_url = "/"
    def post(self, request, *args, **kwargs):
        form = self.form_class(data=request.POST)
        if form.is_valid():
            user = form.save(commit=False)
            password = form.cleaned_data.get("password1")
            user.set_password(password)
            user.save()
        return redirect("login")
        
        
    def dispatch(self, request, *args, **kwargs):
        if self.request.user.is_authenticated:
            return HttpResponseRedirect(self.get_success_url())
        return super().dispatch(self.request, *args, **kwargs)
    def get_success_url(self):
        if "next" in self.request.GET and self.request.GET["next"] != "":
            return self.request.GET["next"]
        else:
            return self.success_url
            
            
    def get_form_class(self):
        return self.form_class


</code></pre>
</div>

<p>The issue here arises from the <code class="highlighter-rouge">get_success_url</code> function and an <strong>Open Redirect</strong> vulnerability.. This function checks for a parameter called <code class="highlighter-rouge">next</code> and makes a redirect to this parameter value. As such it is possible to <code class="highlighter-rouge">djangoapplication?next=//attackersite.url</code>. This redirect will happen after <code class="highlighter-rouge">self.request.user.is_authenticated</code> is successful.</p>

<h3 id="challenge-2httpstwittercomsonarsourcestatus1334165427719725058"><a href="https://twitter.com/SonarSource/status/1334165427719725058">Challenge 2</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>package com.example.restservice;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.concurrent.atomic.AtomicLong;
import java.util.logging.Logger;
import org.springframework.web.bind.annotation.*;
import org.apache.commons.io.IOUtils;
import org.apache.http.entity.StringEntity;
import org.apache.http.entity.ContentType;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.util.EntityUtils;
@RestController
public class RequestController {
    private static final Logger logger = null;
    private final AtomicLong counter = new AtomicLong();
    @RequestMapping(value = {"/api/adapter/{adapter}/activate/{b}"}, 
            method = RequestMethod.POST, produces = "application/json")
    public String activateAdapter(
            @PathVariable("adapter") String connName, 
            @PathVariable("b") Integer b) throws IOException {
        logger.info("activating adapter.");
        HttpPost post = new HttpPost("https://" + connName + "/v1/boot");
        String requestBody = "{\"activate\":" + Integer.toString(b) + "}";
        StringEntity requestEntity = new StringEntity(
            requestBody, 
            ContentType.APPLICATION_JSON
        );
        post.setEntity(requestEntity);
        try (CloseableHttpClient httpClient = HttpClients.createDefault();
             CloseableHttpResponse response = httpClient.execute(post)) {
            logger.info("response:" + response.getEntity());
            return EntityUtils.toString(response.getEntity());
        }
    }
}

</code></pre>
</div>

<p>The issue here arises from the <code class="highlighter-rouge">adapter</code> parameter coming from user input. This is given as part of the <code class="highlighter-rouge">HttpPost</code> constructor and a new object called <code class="highlighter-rouge">post</code>is made which has <code class="highlighter-rouge">"https://" + connName + "/v1/boot"</code>. This is then given to the <code class="highlighter-rouge">httpClient.execute</code> method which will make a request to the crafted url and return the response. This can be abused for an <strong>Server Side Request Forgery (SSRF)</strong> attack.</p>

<h3 id="challenge-3httpstwittercomsonarsourcestatus1334527819402145792"><a href="https://twitter.com/SonarSource/status/1334527819402145792">Challenge 3</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php 
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;
class LoginController extends AbstractController {
    private DOMDocument $doc;
    private $authFile = 'employees.xml';
    
    private function auth($userId, $passwd) {
        $this-&gt;doc-&gt;load($this-&gt;authFile);
        $xpath = new DOMXPath($this-&gt;doc);
        $filter = "[loginID=$userId and passwd='$passwd'][position()&lt;=1]";
        $employee = $xpath-&gt;query("/employees/employee$filter");
        return ($employee-&gt;length == 0) ? false : true;
    }    
    public function index(Request $request) {
        $userId = (int)$request-&gt;request-&gt;get('userId');
        $password = $request-&gt;request-&gt;get('password');
        if ($request-&gt;request-&gt;get('submit') !== null) {
            try {
                if (!$this-&gt;auth($userId, $password)) {
                    return $this-&gt;json(['error' =&gt; "Wrong $userId."]);
                }
                else {
                    $this-&gt;loginCompleted(true);
                    $this-&gt;loadUserInformation($employee);
                }
            } catch (Exception $e) {
                return $this-&gt;json(['error' =&gt; "Login Failed."]);
            }
        }
        return $this-&gt;json(['error' =&gt; "Login Succeeded."]);
    }
}
</code></pre>
</div>

<p>The vulnerability here is an <strong>XPath Injection</strong>. Within function <code class="highlighter-rouge">auth</code>, the <code class="highlighter-rouge">$userId</code> and <code class="highlighter-rouge">$passwd</code> parameter is used to create an XPath query without any sanitization/validation: <code class="highlighter-rouge">loginID=$userId and passwd='$passwd'</code>This query is used to check if the provided <code class="highlighter-rouge">userid</code> and <code class="highlighter-rouge">password</code> exists within <code class="highlighter-rouge">employees.xml</code>. This check is within the line <code class="highlighter-rouge">return ($employee-&gt;length == 0) ? false : true;.</code> This could be abused by a user and bypass this check by injecting something like <code class="highlighter-rouge">' OR '6'='6</code> .</p>

<h3 id="challenge-4httpstwittercomsonarsourcestatus1334890204843347969"><a href="https://twitter.com/SonarSource/status/1334890204843347969">Challenge 4</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>using System.IO;
using System.Net;
using System.Net.Http;
using Microsoft.AspNetCore.Mvc;
namespace core_api.Controllers
{
    public class DataDownloadController : Controller {
        public readonly string AvatarFolder = "images/avatars/";
        [HttpGet]
        public HttpResponseMessage GetAvatar(string image) {
            if (string.IsNullOrWhiteSpace(image) || image.Contains("/")) {
                return new HttpResponseMessage(HttpStatusCode.BadRequest) {
                    Content =  new StringContent("Valid avatar required")};    
            }
            string img = System.IO.Path.Combine(AvatarFolder, image);
            if (!img.Contains(AvatarFolder) || !System.IO.File.Exists(img)) { 
                return new HttpResponseMessage(HttpStatusCode.NotFound) {
                    Content =  new StringContent("Avatar not found")};
            }
            var fileInfo = new System.IO.FileInfo(img);
            var type = fileInfo.Extension;
            var c = new StreamContent(fileInfo.OpenRead());
            c.Headers.ContentType = new System.Net.Http.Headers.
                MediaTypeHeaderValue("image/" + type);
            return new HttpResponseMessage(HttpStatusCode.OK){Content = c};
        }
    }
}

</code></pre>
</div>

<p>In the above C# code, the source where tainted data is coming from the <code class="highlighter-rouge">HttpGet</code> method. This is then given to the <code class="highlighter-rouge">GetAvatar</code> as an argument. This function checks if the user value contains a <code class="highlighter-rouge">/</code> character and if it does, an error is returned to the user. If this check is not triggered, then the user provided value is combined with <code class="highlighter-rouge">images/avatar</code> path using the <code class="highlighter-rouge">System.IO.Path.Combine</code> method. A new constructor is created with the <code class="highlighter-rouge">System.IO.FileInfo</code> class which provides methods for creation, copying, deletion, moving, and opening of files. The <code class="highlighter-rouge">File.OpenRead</code> method is used to fetch the file in this path. On windows systems, the <code class="highlighter-rouge">..\</code> pattern or <code class="highlighter-rouge">../</code> pattern can be used to traverse directories. As such, the above code is vulnerable to <strong>Path Traversal</strong>.</p>

<h3 id="challenge-5httpstwittercomsonarsourcestatus1335252597993689088"><a href="https://twitter.com/SonarSource/status/1335252597993689088">Challenge 5</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>from django.contrib import messages
from django.shortcuts import render, redirect
from django.contrib.sites.shortcuts import get_current_site
from django.template.loader import render_to_string
from django.utils.http import urlsafe_base64_encode, urlsafe_base64_decode
from django.utils.encoding import force_bytes, force_text
from django.views.decorators.http import require_http_methods
from hashlib import sha1
from project.decorators import check_recaptcha
from project.forms import UserSignUpForm
from project.settings import config
from sendgrid import SendGridAPIClient
from sendgrid.helpers.mail import Mail
from django.contrib.auth import get_user_model
User = get_user_model()
@check_recaptcha
@require_http_methods(["POST"])
def register(request):
    form = UserSignUpForm(request.POST)
    if form.is_valid() and request.recaptcha_is_valid:
        user = form.save(commit=False)
        user.is_active = False
        user.save()
        message = render_to_string('mail/activate.html', {
            'user': user,
            'uid': urlsafe_base64_encode(force_bytes(user.pk)),
            'token': sha1(force_bytes(user.pk)).hexdigest(),
        })
        message = Mail(
            from_email='noreply@' + get_current_site(request).domain,
            to_emails=request.POST.get('email'),
            subject='Your account activation email',
            html_content=message)
        response = SendGridAPIClient(config['SG_API_KEY']).send(message)
        messages.add_message(request, messages.SUCCESS, 'Verification email sent.')
    else:
        return render(request, 'account/register.html', {'form': form})
    return render(request, 'account/register.html', {'form': UserSignUpForm()})
</code></pre>
</div>

<p>In the above code, the <code class="highlighter-rouge">SHA1</code> hashing algorithm is used without a salt to generate a token.: <code class="highlighter-rouge">sha1(force_bytes(user.pk)).hexdigest()</code>. As such, an attacker could generate a list of SHA1 hashes and try and brute force the password reset email token of a user. The vulnerability here is <strong>Insecure Token Generation</strong>.</p>

<h3 id="challenge-6httpstwittercomsonarsourcestatus1335614981224738816"><a href="https://twitter.com/SonarSource/status/1335614981224738816">Challenge 6</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>package org.example;
import javax.servlet.ServletException;
import javax.servlet.http.*;
import java.io.*;
public class IndexServlet extends HttpServlet {
    private String referer;
    private ExportIcalManager exportManager;
    private void exportIcal(HttpServletResponse res, String sessionId) 
            throws ServletException, IOException {
        res.addHeader("Access-Control-Allow-Origin", referer);
        res.setContentType("text/plain");
        ExportIcalManager exportManager = new ExportIcalManager(sessionId);
        String filePath = exportManager.exportIcalAgendaForSynchro();
        OutputStream os = res.getOutputStream();
        FileInputStream fs = new FileInputStream(filePath);
        int i;
        while (((i = fs.read()) != -1)) { os.write(i); }
        os.close();
    }
    protected void doPost(HttpServletRequest req, HttpServletResponse res) 
            throws ServletException, IOException {
        HttpSession session = req.getSession();
        referer = req.getParameter("referer");
        exportIcal(res, req.getRequestedSessionId());
    }
}
</code></pre>
</div>

<p>This vulnerability the above code is exposed to is <strong>Misconfigured Cross Origin Resource Sharing (Cors)</strong>. The referer header from a userâ€™s request is used to set the <code class="highlighter-rouge">Access-Control-Allow-Origin</code> header. An attacker could spoof this header to provide a wildcard <code class="highlighter-rouge">*</code>, or modify this through a redirect from an attacker site to allow cross origin communication.</p>

<h3 id="challenge-7httpstwittercomsonarsourcestatus1335614981224738816"><a href="https://twitter.com/SonarSource/status/1335614981224738816">Challenge 7</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
class Upload
{
    private $detect_mime = TRUE;
    private $type_regex = '/^([a-z\-]+\/[a-z0-9\-\.\+]+)(;\s.+)?$/';
    public function do_upload($field = 'userfile') {
        $file = $_FILES[$field];
        $this-&gt;file_size = $file['size'];
        $this-&gt;_file_mime_type($file);
    }
    private function _file_mime_type($file) {
        if (function_exists('finfo_file')) {
            $finfo = @finfo_open(FILEINFO_MIME);
            $mime = @finfo_file($finfo, $file['tmp_name']);
            if (preg_match($this-&gt;type_regex, $mime, $match)) {
                return $this-&gt;file_type = $match[1];
            }
        }
        $cmd = 'file --brief --mime '.$file['name'].' 2&gt;&amp;1';
        exec($cmd, $mime, $status);
        if ($status === 0 &amp;&amp; preg_match($this-&gt;type_regex, $mime, $match)) {
            return $this-&gt;file_type = $match[1];
        }
    }
}
$upload = new Upload();
$upload-&gt;do_upload();
</code></pre>
</div>

<p>The <code class="highlighter-rouge">do_upload</code> function takes a user provided file (i assume) and the <code class="highlighter-rouge">file_mime_type</code> function is called to open this file. The name of this file is taken by the <code class="highlighter-rouge">$file['name']</code> object and is provided as part to the <code class="highlighter-rouge">exec</code> (<code class="highlighter-rouge">$cmd = 'file --brief --mime '.$file['name'].' 2&gt;&amp;1';</code>) function. The vulnerability here is a <strong>Command Injection</strong>.</p>

<h3 id="challenge-8httpstwittercomsonarsourcestatus1336352473871769603"><a href="https://twitter.com/SonarSource/status/1336352473871769603">Challenge 8</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>using Microsoft.AspNetCore.Html;
using Microsoft.AspNetCore.Mvc;
using System.Text.Encodings.Web;
using System;
using System.Threading;
using System.Threading.Tasks;
namespace Core31Demo.Controllers
{
    public class HomeController : Controller {        
        [HttpGet]
        public async Task&lt;IActionResult&gt; Logout(string logoutId) {
            ViewBag.Logout = "Please confirm logout &amp;#8230;";
            if (User.Identity.IsAuthenticated == false) {
                return await Logout(new LogoutViewModel { LogoutId = logoutId });
            }
            return View("ConfirmLogout");
        }
        [HttpPost][ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; Logout(LogoutViewModel model) {
            await PerformSignOutAsync(model);
            ViewData["Logout"] = model.LogoutId;
            return View("Logout");
        }
        
        static async Task PerformSignOutAsync(LogoutViewModel model) {
            // sign out logic
            // throw new NotImplementedException();
        }
    }
    
    public class LogoutViewModel {
         public string LogoutId; 
    }
}


// Views/Home/Logout.cshtml

&lt;div class="page-header"&gt;
    &lt;h1&gt;@Html.Raw(@ViewBag.Logout)&lt;/h1&gt;&lt;/div&gt;
&lt;div class="logout-back"&gt;&lt;a asp-controller="Home" 
     asp-action="Login" asp-route-id="@ViewData["Logout"]"&gt;back&lt;/a&gt;
&lt;/div&gt;


</code></pre>
</div>
<p>A <strong>Cross-site Scripting (XSS)</strong> issue exists in the above code. User input is taken as the <code class="highlighter-rouge">logoutId</code> parameter ( through <code class="highlighter-rouge">HttpGet</code>). A new <code class="highlighter-rouge">LogoutViewModel</code> instance is created with the <code class="highlighter-rouge">logoutId</code> parameter: <code class="highlighter-rouge">Logout(new LogoutViewModel { LogoutId = logoutId });</code>. This is then given to the <code class="highlighter-rouge">Task</code> method which bind its to the <code class="highlighter-rouge">@ViewBag.Logout</code> model attribtue. The method <code class="highlighter-rouge">Html.Raw()</code> returns an IHtmlString with any HTML encoding. As such, XSS is possible.</p>

<h3 id="challenge-9httpstwittercomsonarsourcestatus1336702146276888577"><a href="https://twitter.com/SonarSource/status/1336702146276888577">Challenge 9</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>from __future__ import unicode_literals
import os
import shutil
import tempfile
import traceback
import zipfile
from django import forms
from django.http.response import HttpResponseRedirect
from django.utils.translation import ugettext_lazy as _
from django.views.generic import FormView
from django.views.decorators.csrf import csrf_exempt
class AddonUploadView(FormView):
    form_class = forms.Form
    template_name = "package/addon/upload.jinja"
    def get_addon_path(self):
        filename = os.path.basename(self.request.GET.get("my_file"))
        tmp_token = self.request.GET.get('my_token')
        path = os.path.join(tempfile.gettempdir(), tmp_token, filename)
        if not os.path.isfile(path):
            raise ValueError("Error! File not found.")
        if hasattr(os, "geteuid") and os.stat(path).st_uid != os.geteuid():
            raise ValueError("Error! File not owned by current user.")
        return path
    @csrf_exempt
    def form_valid(self, form):
        try:
            installer.install_package(self.get_addon_path())
            response["success"] = True
        except Exception:
            os.unlink(self.get_addon_path())
            response["success"] = False
        return self.render_to_response(response)

</code></pre>
</div>
<p>Three issues are described in the above code:</p>

<ul>
  <li><strong>Cross Site Request Forgery</strong> - <code class="highlighter-rouge">@csrf_exempt</code> in Django removes Cross Site Request Forgery protection allowing the request to be forged by an attacker.</li>
  <li><strong>Path Traversal</strong> - The <code class="highlighter-rouge">path</code> generated by the <code class="highlighter-rouge">AddonUploadView</code> function is user tainted.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>        filename = os.path.basename(self.request.GET.get("my_file"))
        tmp_token = self.request.GET.get('my_token')
        path = os.path.join(tempfile.gettempdir(), tmp_token, filename)
</code></pre>
</div>
<p>This is then given to the <code class="highlighter-rouge">os.stat(path)</code> function which will execute the file provided by the user tainted path allowing execution of a user controlled file. This same also exists in <code class="highlighter-rouge">os.unlink(self.get_addon_path())</code> where a path traversal can lead to arbritary file delete.</p>

<h3 id="challenge-10httpstwittercomsonarsourcestatus1337064532355633152"><a href="https://twitter.com/SonarSource/status/1337064532355633152">Challenge 10</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>import javax.servlet.*;
import javax.servlet.annotation.WebServlet;
import java.io.*;
import java.util.Enumeration;
import java.util.HashSet;
import java.util.Set;
import java.util.zip.ZipEntry;
import java.util.zip.ZipFile;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
@WebServlet(value="/unzip", name="ZipUtils")
class ZipUtils extends GenericServlet {
    private static final String BASE_DIR = "projects";
    @Override
    public void service(ServletRequest req, ServletResponse res) throws IOException {
        File zipFile = new File(BASE_DIR, req.getParameter("file"));
        if (zipFile.getCanonicalPath().startsWith(BASE_DIR)) {
            File indir = new File("/tmp/local/my_jars");
            unjar(zipFile, indir);
        }
    }
    private File[] unjar(File uploadFile, File inDir) throws IOException {
        String uploadFileName = inDir + File.separator + uploadFile.getName();
        ZipFile uploadZipFile = new ZipFile(uploadFile);
        Set&lt;File&gt; files = new HashSet&lt;File&gt;();
        Enumeration entries = uploadZipFile.entries();
        // unpack uploaded zip file
        while (entries.hasMoreElements()) {
            ZipEntry entry = (ZipEntry) entries.nextElement();
            File fe = new File(uploadFileName, entry.getName());
            if (entry.isDirectory()) {
                fe.mkdirs();
            } else {
                if (fe.getParentFile() != null 
                &amp;&amp; !fe.getParentFile().exists()) {
                    fe.getParentFile().mkdirs();
                }
                files.add(fe);
                IOUtils.copy(uploadZipFile.getInputStream(entry), 
                    new BufferedOutputStream(new FileOutputStream(fe)));
            }
        }
        uploadZipFile.close();
        return files.toArray(new File[files.size()]);
    }
}

</code></pre>
</div>

<p>The above code is vulnerable to <strong>Zip Path Traversal</strong>.  User input (source) is entering via <code class="highlighter-rouge">uploadZipFile.entries()</code> method (<code class="highlighter-rouge">Map.Entry</code>). The code iterates through this <code class="highlighter-rouge">Map</code> and the <code class="highlighter-rouge">getInputStream</code> method is used to fetch the file and <code class="highlighter-rouge">IOUtils.copy</code> is used to copy bytes from an <code class="highlighter-rouge">InputStream </code>to chars on a Writer.</p>

<p>As such, you can create a ZIP archive containing an archive path such as <code class="highlighter-rouge">..\..\..\newfile</code> and this file will be written outside the destination directory. This could be abused to overwrite files within the system.</p>

<h3 id="challenge-11httpstwittercomsonarsourcestatus1337411824627552257"><a href="https://twitter.com/SonarSource/status/1337411824627552257">Challenge 11</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
use Illuminate\Routing\Controller;
use Illuminate\Http\Response;
use Illuminate\Support\Facades\Request;
class Authenticate{
    private function getEmail($email_field, $user_data) {
        foreach($email_field as $field) {
            if (isset($user_data[0][$field][0])) {
                return $user_data[0][$field][0];
            }
        }
        return NULL;
    }
    public function findUsername() {
        $envvar = $this-&gt;settings['fields']['envvar'];
        $ldapdn = Config::read('WebApp.ldapDN');
        $ldapSearchFilter = Config::read('WebApp.ldapSearchFilter');
        $ldapEmailField = Config::read('WebApp.ldapEmailField');
        $ldapconn = ldap_connect(Config::read('WebApp.ldapServer')) 
            or die('LDAP server connection failed');
        if (!($ldapbind = ldap_bind($ldapconn))) {
            die("LDAP bind failed");
        }
        if (!empty($ldapSearchFilter)) {
            $filter = '(&amp;' . $ldapSearchFilter . '(' .
            Config::read('WebApp.ldapSearchAttribut') . '=' .
            Request::input($envvar) . '))';
        }
        $getLdapUserInfo = Config::read('WebApp.ldapFilter');
        $result = ldap_search($ldapconn, $ldapdn, $filter, $getLdapUserInfo)
            or die("LDAP Error: " . ldap_error($ldapconn));
        $ldapUserData = ldap_get_entries($ldapconn, $result);
        if (!isset($ldapEmailField) &amp;&amp; isset($ldapUserData[0]['mail'][0])) {
            $username = $ldapUserData[0]['mail'][0];
        } else if (isset($ldapEmailField)) {
            $username = $this-&gt;getEmail($ldapEmailField, $ldapUserData);
        } else {
            die("User not found in LDAP");
        }
        ldap_close($ldapconn);
        return $username;
    }
}

</code></pre>
</div>

<p>User concentated data is inserted to the  <code class="highlighter-rouge">ldap_search</code> function resulting in <strong>LDAP Injection</strong>: <code class="highlighter-rouge">ldap_search($ldapconn, $ldapdn, $filter, $getLdapUserInfo)</code> An ldap query is created with <code class="highlighter-rouge">ldapSearchFilter</code> and <code class="highlighter-rouge">$envvar</code>. <code class="highlighter-rouge">$envvar</code> can be user controlled data, and as such LDAP Injection is possible.</p>

<h3 id="challenge-12httpstwittercomsonarsourcestatus1337789307386359812"><a href="https://twitter.com/SonarSource/status/1337789307386359812">Challenge 12</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>using System;
using System.Collections;
using System.Globalization;
using System.Text.RegularExpressions;
using Microsoft.AspNetCore.Mvc;
using System.Linq;
namespace core_api.Controllers
{
    public class BlogPost {
        public DateTime ReleaseDate { get; set; }
        public string Content { get; set; }
    }
    public class BlogController : Controller
    {
        ArrayList Posts = new ArrayList();
        string Keyword = "[highlight]";
        
        public void init() {
            Posts.Add(new BlogPost{ReleaseDate = new DateTime(2009, 8, 1, 0, 0, 0), Content="[highlight]"});
        }
       
        [Route("api/search")]
        [HttpGet]
        public ArrayList search(string search, string since) {
            DateTime.TryParseExact(since, "MM-dd-yy", null,
                DateTimeStyles.None, out var parsedDate);
            var blogposts = from BlogPost blog in Posts
                where DateTime.Compare(blog.ReleaseDate, parsedDate) &gt; 0
                select blog.Content;
            ArrayList result = new ArrayList();
            foreach (var content in blogposts) {
                String tmp = content.Replace(Keyword, search);
                Regex rx = new Regex(search);
                Match match = rx.Match(tmp);
                if(match.Success) {
                    result.Add(match.Value);
                }
            }
            return result;
        }
    }
}

</code></pre>
</div>
<p>A <strong>Reject Injection/ReDoS</strong> vulnerability exists in the above code. The <code class="highlighter-rouge">search</code> argument is provided by user input. This is then provided to the <code class="highlighter-rouge">Regex</code> constructor and the user provided input is used for the regex match. An attacker could provide a large regex which could lead to backtracking when eveluating with <code class="highlighter-rouge">Regex</code>.</p>

<h3 id="challenge-13httpstwittercomsonarsourcestatus1338151696439107584"><a href="https://twitter.com/SonarSource/status/1338151696439107584">Challenge 13</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>import os
import requests
import errno
from django.conf import settings
class Sitemap():
    domain = "sonarsource.com"
    def __init__(self, filename="sitemap.xml"):
	self.url = "http://" + self.domain
        if not self.url.endswith('/'):
            self.url += '/'
        self.url += filename
        self.destination = os.path.join(settings.STATIC_ROOT, filename)
	
    def fetch(self, dataset=None):
        headers = {'User-Agent': 'Mozilla/5.0 Chrome/50.2661 Safari/537.36'}
        try:
            response = requests.get(self.url, timeout=30, headers=headers)
        except requests.exceptions.SSLError:
            response = requests.get(self.url, verify=False, headers=headers)
        finally:
            pass
        with open(self.destination, 'wb') as f:
            f.write(response.content)

</code></pre>
</div>

<p>Two issues exist in the above code:</p>
<ul>
  <li><code class="highlighter-rouge">http://</code> protocol URI is used as the URL that will be used by <code class="highlighter-rouge">requests.get</code>. <strong>Usage of Plain text protocols</strong>** are considered bad practice.</li>
  <li>The <code class="highlighter-rouge">verify=False</code> option is set for <code class="highlighter-rouge">requests.get</code>. This is disables server certificate validation and is considered to be <strong>Insecure Configuration</strong>.</li>
</ul>

<h3 id="challenge-14httpstwittercomsonarsourcestatus1338514090755440641"><a href="https://twitter.com/SonarSource/status/1338514090755440641">Challenge 14</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.Properties;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
public class IndexServlet {
    private final ServletContext context;
    private final String templateFile = "/org/java/repository.xml";
        
    public IndexServlet(ServletContext context) {
        this.context = context;
    }
    
    public void installRepository(HttpServletRequest req)
            throws ServletException, IOException {
        String mode = req.getParameter("mode");
        String repHome = req.getParameter("repository_home");
        if (repHome != null &amp;&amp; mode != null &amp;&amp; "new".equals(mode)) {
            installConfig(new File(repHome));
        }
    }
    private void installConfig(File dest) throws IOException {
        InputStream in = context.getResourceAsStream(templateFile);
        OutputStream out = new FileOutputStream(dest);
        byte[] buffer = new byte[8192]; int read;
        while ((read = in.read(buffer)) &gt;= 0) {
            out.write(buffer, 0, read);
        }
        in.close();
        out.close();
    }
}

</code></pre>
</div>
<p>Tainted source is flowing from <code class="highlighter-rouge">req.getParameter("repository_home");</code>, this is the provided to the <code class="highlighter-rouge">new File</code> constructor and flows to the <code class="highlighter-rouge">installConfig</code> method. The user input then flows to the <code class="highlighter-rouge">FileOutputStream(dest)</code> method which creates a new file in the give file path, resulting in <strong>Arbritary File Write</strong>.</p>

<h3 id="challenge-15httpstwittercomsonarsourcestatus1338868922225856516"><a href="https://twitter.com/SonarSource/status/1338868922225856516">Challenge 15</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
if ('restore' == $_GET['action']) {
    $upload = $_FILES['filename'];
    $upload_tmp = $_FILES['filename']['tmp_name'];
    $upload_name = $_FILES['filename']['name'];
    $upload_error = $_FILES['filename']['error'];
    if ($upload_error &gt; 0) {
        switch ($upload_error) {
            case UPLOAD_ERR_INI_SIZE:
                break;
            default:
                echo sprintf("Error %s", $upload_error);
        }
    }
    if (!$upload_name &amp;&amp; isset($_POST['file'])) {
    $upload_name = filter_input(INPUT_POST,'file',FILTER_SANITIZE_STRING);
    } else {
        $ret_val = do_upload($upload_tmp, $upload_name);
    }
    echo '&lt;p&gt;&lt;b&gt;restore from ' . $upload_name . '&lt;/b&gt;';
}
</code></pre>
</div>

<p>Multiple issues exist in the above code:</p>

<ul>
  <li>An <strong>Insufficient Validation</strong> issue exists where a file with any extension can be uploaded</li>
  <li>Two <strong>Cross-site Scripting (XSS)</strong> issues exist. One within the <code class="highlighter-rouge">sprintf</code> sink where <code class="highlighter-rouge">$upload_error</code> is reflected back a a user. Another XSS exists where <code class="highlighter-rouge">$upload_name</code> is reflected back to a user in the <code class="highlighter-rouge">echo</code> statement.</li>
</ul>

<h3 id="challenge-16httpstwittercomsonarsourcestatus1339226778477285376"><a href="https://twitter.com/SonarSource/status/1339226778477285376">Challenge 16</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>using System;
using System.IO;
using System.Xml;
using System.Xml.Serialization;
using Microsoft.AspNetCore.Mvc;
[Serializable]
public class ExchangeData {
}
namespace core_api.Controllers {
    public class ShareDataController : Controller {
        [Route("import/exchange")] 
        [HttpPost]
        public string ImportExchangeData(string content) {
            var xmlDoc = new XmlDocument { XmlResolver = null };
            xmlDoc.LoadXml(content); 
            var rootItem = (XmlElement)xmlDoc.SelectSingleNode("root");
            var dataType = Type.GetType(rootItem.GetAttribute("data"));
            var reader = new StringReader(rootItem.InnerXml);
            ExchangeData exchange = Import(dataType, reader);
            return exchange.ToString();
        }
        private static ExchangeData Import(Type t, StringReader r) {
            XmlSerializer serializer = new XmlSerializer(t);
            XmlTextReader textReader = new XmlTextReader(r);
            ExchangeData data = (ExchangeData)serializer.Deserialize(textReader);
            return data;
        }
    }
}

</code></pre>
</div>

<p>An <strong>Unsafe Deserialization</strong> vulnerability exists in the above code. <code class="highlighter-rouge">XmlSerializer</code> is used to deserialize user object provided by the <code class="highlighter-rouge">content</code> argument. For <code class="highlighter-rouge">XmlSerializer</code> serializer, the expected type should not come from user-controlled input. In the above code, the expected data type is coming from <code class="highlighter-rouge">rootItem.GetAttribute("data")</code>.</p>

<h3 id="challenge-17httpstwittercomsonarsourcestatus1339586153545150464"><a href="https://twitter.com/SonarSource/status/1339586153545150464">Challenge 17</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>import copy
import io
from http import HTTPStatus
from zipfile import ZipFile
from flask import Blueprint, current_app, jsonify, request, send_file
@FIXTURE_BLUEPRINT.route('/api/export/&lt;business_id&gt;', methods=['GET'])
def get(business_id, table=None):
    con = current_app.config.get('DB_CONNECTION', None)
    if not con:
        current_app.logger.error('Database connection failure')
        return jsonify({'message': 'Database connection error'})
    cur = con.cursor()
    bid = _get_business_id(cur=cur, business_id=business_id)
    if not bid:
        current_app.logger.error(f'{business_id} not found')
        return jsonify({'message': f'Could not find {business_id}.'})
    try:
        tmp_file = _create_export(cur=cur, table=table, bid=bid)
        if not tmp_file:
            return jsonify({'message': f'Failed to create export for {bid}'})
        current_app.logger.error(f'DELETE: {tmp_file}')
        return send_file(attachment_filename=tmp_file, as_attachment=True)
    except Exception as err:
        current_app.logger.error(f'Failed to export')
        con.reset()
        return jsonify({'message': 'Failed to export data.'})

</code></pre>
</div>

<p>A <strong><a href="https://owasp.org/www-community/attacks/Log_Injection">Log Injection</a></strong> vulnerability exists where data source coming from <code class="highlighter-rouge">business_id</code> is validated and if it doesnâ€™t exist, this is logged into the <code class="highlighter-rouge">current_app.logger.error</code> method directly. An attacker could inject CRLF characters (<code class="highlighter-rouge">%0D%0A</code>) and adding additional log entries.</p>

<h3 id="challenge-18httpstwittercomsonarsourcestatus1339956086237929474"><a href="https://twitter.com/SonarSource/status/1339956086237929474">Challenge 18</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>package org.example;
import javax.servlet.ServletException;
import javax.servlet.http.*;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import org.jdom2.Content;
import org.jdom2.Document;
import org.jdom2.JDOMException;
import org.jdom2.input.SAXBuilder;
public class IndexServlet extends HttpServlet {
    private String extractContent() throws IOException, JDOMException {
        File uploadFile = new File("/users/upload/document.odt");
        InputStream in = new FileInputStream(uploadFile);
        final ZipInputStream zis = new ZipInputStream(in);
        ZipEntry entry;
        List&lt;Content&gt; content = null;
        while ((entry = zis.getNextEntry()) != null) {
            if (entry.getName().equals("content.xml")) {
                final SAXBuilder sax = new org.jdom2.input.SAXBuilder();
                Document doc = sax.build(zis);
                content = doc.getContent();
                StringBuilder sb = new StringBuilder();
                if (content != null) {
                    for (Content item : content) {
                        sb.append(item.getValue());
                    }
                }
                zis.close();
                return sb.toString();
            }
        }
        return null;
    }
    protected void doGet(HttpServletRequest req, HttpServletResponse res)
        throws ServletException, IOException
    {
        try {
            extractContent();
        }
        catch(Exception e) {
            return;
        }
    }
}

</code></pre>
</div>

<p><code class="highlighter-rouge">org.jdom2.input.SAXBuilder</code> is used to parse an <code class="highlighter-rouge">.odt</code> file. An <code class="highlighter-rouge">.odt</code> file contains XML files will be parsed by <code class="highlighter-rouge">SAXBuilder</code>, <code class="highlighter-rouge">content.xml</code> in this example. In the above example, <code class="highlighter-rouge">SAXBuilder</code> is set without <code class="highlighter-rouge">builder.setFeature("http://apache.org/xml/features/disallow-doctype-decl",true);</code> which provides an attack vector for <strong>XML External Entity (XXE)</strong>. An attacker could modify the <code class="highlighter-rouge">content.xml</code> to have external entities.</p>

<h3 id="challenge-19httpstwittercomsonarsourcestatus1340326027206209539"><a href="https://twitter.com/SonarSource/status/1340326027206209539">Challenge 19</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
namespace App\Http\Controllers;
use Illuminate\Support\Facades\Request;
use Illuminate\Support\Facades\Response;
use Illuminate\Http\RedirectResponse;
class LessonsController6 extends ApiController {
    public function load(): RedirectResponse {
        if (!empty(Request::cookie('site'))) {
            $site_id = Request::cookie('site');
        } else if (!empty(Request::getHost())) {
            $site_id = Request::getHost();
        } else {
            $site_id = 'default';
        }
        if (empty($site_id) || preg_match('/[^A-Za-z0-9.-_]/', $site_id)) {
            abort(403, 'Invalid ID ' . htmlspecialchars($site_id, ENT_NOQUOTES));
        }
        require_once "sites/$site_id.php";
        if ($config == 1) {
            return redirect()-&gt;route('login', ['site' =&gt; $site_id]);
        } else {
            return redirect()-&gt;route('setup', ['site' =&gt; $site_id]);
        }
    }
}

</code></pre>
</div>

<p>A <strong>Local File Inclusion</strong> exists in the above code. It is possible to set an arbritary path through a host header <code class="highlighter-rouge">(Request::getHost()</code> or a Cookie <code class="highlighter-rouge">Request::cookie('site')</code>, The regex used by the code (<code class="highlighter-rouge">[^A-Za-z0-9.-_]</code>) does not validate <code class="highlighter-rouge">../../</code> and this <code class="highlighter-rouge">$siteid</code> is provided to <code class="highlighter-rouge">require_once "sites/$site_id.php";</code>. The <code class="highlighter-rouge">.php</code> extension can be bypassed using a null byte (<code class="highlighter-rouge">%00</code>).</p>

<h3 id="challenge-20httpstwittercomsonarsourcestatus1340688412450414592"><a href="https://twitter.com/SonarSource/status/1340688412450414592">Challenge 20</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>using System;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Cryptography;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using Org.BouncyCastle.Crypto;
using Org.BouncyCastle.Crypto.Parameters;
using Org.BouncyCastle.Security;
namespace core_api.Controllers
{
    public class ApiController : Controller
    {
        private readonly string publicKey;        
	private readonly string authTokenIssuer;
        
        public ApiController(string publicKey, string authTokenIssuer)     
        {
            this.publicKey = publicKey;
            this.authTokenIssuer = authTokenIssuer;
        }
        
        private String ExportPublicKey(RSACryptoServiceProvider rsa)
        {
            throw new NotImplementedException();
        }
        private RSACryptoServiceProvider ImportKeyParameters(string publicKey)
        {
            throw new NotImplementedException();
        }
	    
        public JwtSecurityToken ValidateToken(string token) {           
            byte[] keyBytes = Convert.FromBase64String(publicKey);
            var keyParams = (RsaKeyParameters)PublicKeyFactory.CreateKey(keyBytes);
            var rsaParams = new RSAParameters {
                Modulus = keyParams.Modulus.ToByteArrayUnsigned(),
                Exponent = keyParams.Exponent.ToByteArrayUnsigned() 
            };
            var rsa = new RSACryptoServiceProvider();
            rsa.ImportParameters(rsaParams);
            rsa.KeySize = 4096;
            var validationParameters = new TokenValidationParameters {
                RequireExpirationTime = true,
                RequireSignedTokens = true,
                ValidIssuer = authTokenIssuer,
                ValidateIssuer = true,
                ValidateLifetime = true,
                IssuerSigningKey = new RsaSecurityKey(rsa)
            };
            var handler = new JwtSecurityTokenHandler();
            handler.ValidateToken(token, validationParameters, out SecurityToken validatedSecurityToken);
            var validatedJwt = validatedSecurityToken as JwtSecurityToken;
            return validatedJwt;
        }       
    }
}
</code></pre>
</div>

<p>The above code is an example of <strong>Insecure Cryptography</strong>. <code class="highlighter-rouge">RSACryptoServiceProvider</code> constructor by default sets the key size to be <code class="highlighter-rouge">1024</code>. The <code class="highlighter-rouge">rsa.KeySize = 4096;</code> assingment does not change the keysize according to the SonarSource expected solution.</p>

<h3 id="challenge-21httpstwittercomsonarsourcestatus1341035697734561792"><a href="https://twitter.com/SonarSource/status/1341035697734561792">Challenge 21</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>import os
import tempfile
'''
Open the pdf reader on windows for the report file
'''
def open_report(report_class, _system="Windows", *args, **kwargs):
    rv = PrintReportEvent.emit(report_class, *args, **kwargs)
    if rv:
        return rv
    filters = kwargs.pop('filters', None)
    if filters:
        kwargs = describe_search_filters_for_reports(filters, **kwargs)
    tmp = tempfile.mktemp(suffix='.pdf', prefix='stoqlib-reporting')
    report = report_class(tmp, *args, **kwargs)
    report.filename = tmp
    if _system == "Windows":
        report.save()
        log.info("Executing PDF reader with %r" % (report.filename, ))
        os.startfile(report.filename)
        return
    if isinstance(report, HTMLReport):
        op = PrintOperationWEasyPrint(report)
        op.set_threaded()
    else:
        op = PrintOperationPoppler(report)
    rv = op.run()
    return rv


</code></pre>
</div>

<p>The issue here arises from the <code class="highlighter-rouge">tempfile.mktemp</code> function being used which allows for potential <strong>Race Condition</strong>. An attacker could create a file of his choice before the <code class="highlighter-rouge">mktemp</code> is triggered by an user.  The following stackoverflow explains this vulnerability: <a href="https://stackoverflow.com/questions/37093444/using-python-tempfiles-permanently">Stackoverflow - using-python-tempfiles-permanently</a></p>

<h3 id="challenge-22httpstwittercomsonarsourcestatus1341035697734561792"><a href="https://twitter.com/SonarSource/status/1341035697734561792">Challenge 22</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>package com.example.restservice;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.servlet.ModelAndView;
import org.hibernate.criterion.Restrictions;
import org.hibernate.criterion.Criterion;
import org.hibernate.type.StringType;
@Controller
@RequestMapping("/nodeList.htm")
public class NodeListController {
    public NodeListModel createNodeList(NodeListCommand command) {
        NodeCriteria criteria = new NodeCriteria(Node.class, "node");
        addNodeCriteria(criteria, command.getNodeParm(), command.getNodeParmValue());
        return createModel(command);
    }
    @RequestMapping(method={ RequestMethod.GET, RequestMethod.POST })
    public ModelAndView handle(@ModelAttribute("command") NodeListCommand command) {
        NodeListModel model = createNodeList(command);
        ModelAndView modelAndView = new ModelAndView("nodeList", "model", model);
        return modelAndView.addObject("command", command);
    }
    private static void addNodeCriteria(NodeCriteria criteria,
            String nodeParm, String nodeParmValue) {
        final String nodeParameterName = ("snmp" + nodeParm).toLowerCase();    
        criteria.add(Restrictions.sqlRestriction(nodeParameterName + " = ?)", 
            nodeParmValue, new StringType()));       
        criteria.createAlias(nodeParm, nodeParameterName);    
    }
    
    private NodeListModel createModel(NodeListCommand command) {
        return new NodeListModel();
    }
}

</code></pre>
</div>

<p>A <strong>SQL Injection</strong> exists in the above code. Tainted data is flowing from source <code class="highlighter-rouge">@ModelAttribute("command") NodeListCommand command</code>. The <code class="highlighter-rouge">command</code> argument is then sent to the <code class="highlighter-rouge">createNodeList</code> method. The <code class="highlighter-rouge">command</code> then flows to the <code class="highlighter-rouge">addNodeCriteria</code> method. The <code class="highlighter-rouge">nodeParm</code> argument from the <code class="highlighter-rouge">addNodeCriteria</code> method is then concentated to the <code class="highlighter-rouge">nodeParameterName</code> variable: final String <code class="highlighter-rouge">nodeParameterName = ("snmp" + nodeParm).toLowerCase();</code>. This then added to the <code class="highlighter-rouge">createAlias</code> HQL sink via <code class="highlighter-rouge">criteria.add</code>resulting in SQL injection.</p>

<h3 id="challenge-23httpstwittercomsonarsourcestatus1341775576986742784"><a href="https://twitter.com/SonarSource/status/1341775576986742784">Challenge 23</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php 
class email_output_html {
    protected function express($expression) {
        $expression = preg_replace(
            array('/env:([a-z0-9_]+)/i',
                '/config:([a-z0-9_]+)(:(\S+))?/i',
            ),
            array("(isset(\$this-&gt;env['\\1']) ? \$this-&gt;env['\\1'] : null)",
                "\$this-&gt;config-&gt;get('\\1', '\\3')",
            ),
            $expression
        );
        return eval("return ($expression);");
    }
    protected function parse_template() {
        $attributes  = html::parse_attrib_string($_POST['_mail_body']);
        foreach($attributes as $attrib) {
            if (!empty($attrib['express'])) {
                $attrib['c'] = $this-&gt;express($attrib['express']);
            }
            if (!empty($attrib['name']) || !empty($attrib['command'])) {
                $attrib['c'] = $this-&gt;button($attrib);
            }
        }
    }
}
class html {
    public static function parse_attrib_string($str) {	
        $attrib = array();
        preg_match_all('/\s*([-_a-z]+)=(["\'])??(?(2)([^\2]*)\2|(\S+?))/Ui', $str, $regs, PREG_SET_ORDER);
		
        if ($regs) {
            foreach ($regs as $attr) {
                $attrib[strtolower($attr[1])] = html_entity_decode($attr[3] . $attr[4]);
            }
        }
        return $attrib;
    }
}
</code></pre>
</div>

<p>A <strong>Code Injection</strong> exists due to the usage of <code class="highlighter-rouge">eval</code>. User input is flowing from the <code class="highlighter-rouge">parse_template</code> function to the <code class="highlighter-rouge">express</code> function as follows: <code class="highlighter-rouge">express($attrib['express']</code> I wasnâ€™t able to find a bypass for the regex used within the <code class="highlighter-rouge">parse_template</code> function; the SonarSource expected solution states that the following  payload can be used: <code class="highlighter-rouge">/config:sonar:'.phpinfo().'</code></p>

<h3 id="challenge-24httpstwittercomsonarsourcestatus1342122866440101889"><a href="https://twitter.com/SonarSource/status/1342122866440101889">Challenge 24</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.IO;
using System.Diagnostics;
using System.Reflection;
namespace core_api
{
    public partial class Form1 : Form
    {
        const int MAX_PATH = 10;
        public Form1()
        {
            InitializeComponent();
        }
        private void btnInstallPackage_Click(object sender, EventArgs e) {
            InstallPackage(txtPackage.Text, CurrentProject.ProjectDirectory);
        }
        public static void InstallPackage(string packageId, string workingDir) {
            string dir = Path.Combine(workingDir, "nuget");
            dir = Path.Combine(dir, packageId).Substring(0, MAX_PATH);
            Directory.CreateDirectory(dir);
            Process nuget = new Process();
            nuget.StartInfo.FileName = Path.Combine(Tools.GetPath(), "nuget");
            nuget.StartInfo.Arguments = "install "+packageId+" -NonInteractive";
            nuget.StartInfo.CreateNoWindow = true;
            nuget.StartInfo.RedirectStandardOutput = true;
            nuget.StartInfo.RedirectStandardError = true;
            nuget.StartInfo.WorkingDirectory = dir;
            nuget.StartInfo.StandardOutputEncoding = System.Text.Encoding.UTF8;
            nuget.StartInfo.UseShellExecute = false;
            nuget.Start();
        }
    }
    class Tools
    {
        public static string GetPath()
        {
            return "D:\\test\\VisualNuget\\nuget";
        }
    }
    class CurrentProject
    {
        public static string ProjectDirectory = "D:\\test\\VisualNuget";
    }
}
</code></pre>
</div>

<p>The issue here arisies from the <code class="highlighter-rouge">InstallPackage</code> method taking a <code class="highlighter-rouge">packageId</code> parameter. This parameter is concentated into the arguments :<code class="highlighter-rouge">nuget.StartInfo.Arguments = "install "+packageId+" -NonInteractive";</code>and is ran as part of the <code class="highlighter-rouge">nuget</code> command. It is not possible to conduct a Command Injection attack due to user input only ending up in <code class="highlighter-rouge">nuget.StartInfo.Arguments</code> but <strong>Argument Injection</strong> is possible and run the command with additional arguments that the binary wasnâ€™t expecting.</p>

</article>





<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
      <a href="//twitter.com/share?text=Code+Security+Advent+Calendar+2020+Answers&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2020%2F12%2F28%2Fcode-security-advent-calendar-answers.html&via=snoopysecurity"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
        <i class="fa fa-twitter-square fa-lg"></i>
      </a>
    
    
    
    
    
    
    
  
    
    
    
      <a href="//www.facebook.com/sharer.php?t=Code+Security+Advent+Calendar+2020+Answers&u=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2020%2F12%2F28%2Fcode-security-advent-calendar-answers.html"
        onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
      <a href="//www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2020%2F12%2F28%2Fcode-security-advent-calendar-answers.html"
        onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;">
        <i class="fa fa-linkedin-square fa-lg"></i>
      </a>
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
      <a href="//www.pinterest.com/pin/create/button/?description=Code+Security+Advent+Calendar+2020+Answers&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fweb-application-security%2F2020%2F12%2F28%2Fcode-security-advent-calendar-answers.html&media=http://snoopysecurity.github.io/assets/logo-sonarsource.png"
        onclick="window.open(this.href, 'pinterest-share', 'width=550,height=255');return false;">
        <i class="fa fa-pinterest-square fa-lg"></i>
      </a>
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
</section>




</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">ðŸ’» | Blog</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">About</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:na">
            <i class="fa fa-envelope-o"></i>
            <span class="username">na</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://twitter.com/snoopysecurity" title="Follow me on Twitter">
              <i class="fa fa-twitter"></i>
              <span class="username">snoopysecurity</span>
            </a>
          </li>
          
        
          
        
          
          <li>
            <a href="https://github.com/snoopysecurity" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">snoopysecurity</span>
            </a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">Hacking to learn, while learning to hack.
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });
});

</script>






  </body>

</html>
