<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Facebook CTF 2019: Products Manager Writeup</title>
  <meta name="description" content="This challenge was part of Facebook CTF . Looking at the challenge tab, the following information is provided:">
  
  <meta name="author" content="Sam Sanoop">
  <meta name="copyright" content="&copy; Sam Sanoop 2019">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="This challenge was part of Facebook CTF . Looking at the challenge tab, the following information is provided:" />
  <meta property="og:url" content="http://snoopysecurity.github.io" />
  <meta property="og:site_name" content="ðŸ’» | Blog" />
  <meta property="og:title" content="Facebook CTF 2019: Products Manager Writeup" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://snoopysecurity.github.io/assets/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Facebook CTF 2019: Products Manager Writeup">
  <meta name="twitter:description" content="This challenge was part of Facebook CTF . Looking at the challenge tab, the following information is provided:">
  <meta name="twitter:image" content="http://snoopysecurity.github.io/assets/logo.png">
  <meta name="twitter:url" content="http://snoopysecurity.github.io">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://snoopysecurity.github.io/capture_the_flag/2019/06/08/10_Facebook_CTF_product_manager.html">
  <link rel="alternate" type="application/rss+xml" title="ðŸ’» | Blog" href="http://snoopysecurity.github.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="ðŸ’» | Blog">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
          <li class="nav-link"><a href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <li class="nav-link"><a href="/posts/">Posts</a>
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">Facebook CTF 2019: Products Manager Writeup</h1>
      <p class="info">by <strong>snoopysecurity</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">June 8, 2019</div>
  <div class="post-categories">
  in 
    
    <a href="/category/capture_the_flag">Capture_the_flag</a>
    
  
  </div>
</section>

<article class="post-content">
  <p>This challenge was part of <a href="https://www.fbctf.com/">Facebook CTF </a>. Looking at the challenge tab, the following information is provided:</p>

<p><img src="/assets/facebookctf/7.png" alt="alt text" title="img7" /></p>

<p>Going to the provided URL, this leads to the following web application where you can add and view your own products.</p>

<p><img src="/assets/facebookctf/8.png" alt="alt text" title="image9" /></p>

<p>Going to the view products area shows the top 5 products within the application.</p>

<p><img src="/assets/facebookctf/10.png" alt="alt text" title="image10" /></p>

<p>To add a product, a secret needs to be created. After a product is added, this can be viewed and by submitting the product name and the secret. The source code the application is also provided for the challenge.</p>

<p>index.php</p>
<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php

require_once("db.php");

$products = get_top_products();

require_once("header.php");
?&gt;

&lt;p&gt;
  &lt;ul&gt;
&lt;?php
foreach ($products as $product) {
  echo "&lt;li&gt;" . htmlentities($product['name']) . "&lt;/li&gt;";
}
?&gt;
  &lt;/ul&gt;
&lt;/p&gt;

&lt;?php require_once("footer.php");
</code></pre>
</div>
<p>db.php</p>
<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php
/*
CREATE TABLE products (
  name char(64),
  secret char(64),
  description varchar(250)
);

INSERT INTO products VALUES('facebook', sha256(....), 'FLAG_HERE');
INSERT INTO products VALUES('messenger', sha256(....), ....);
INSERT INTO products VALUES('instagram', sha256(....), ....);
INSERT INTO products VALUES('whatsapp', sha256(....), ....);
INSERT INTO products VALUES('oculus-rift', sha256(....), ....);
*/
error_reporting(0);
require_once("config.php"); // DB config

$db = new mysqli($MYSQL_HOST, $MYSQL_USERNAME, $MYSQL_PASSWORD, $MYSQL_DBNAME);

if ($db-&gt;connect_error) {
  die("Connection failed: " . $db-&gt;connect_error);
}

function check_errors($var) {
  if ($var === false) {
    die("Error. Please contact administrator.");
  }
}

function get_top_products() {
  global $db;
  $statement = $db-&gt;prepare(
    "SELECT name FROM products LIMIT 5"
  );
  check_errors($statement);
  check_errors($statement-&gt;execute());
  $res = $statement-&gt;get_result();
  check_errors($res);
  $products = [];
  while ( ($product = $res-&gt;fetch_assoc()) !== null) {
    array_push($products, $product);
  }
  $statement-&gt;close();
  return $products;
}

function get_product($name) {
  global $db;
  $statement = $db-&gt;prepare(
    "SELECT name, description FROM products WHERE name = ?"
  );
  check_errors($statement);
  $statement-&gt;bind_param("s", $name);
  check_errors($statement-&gt;execute());
  $res = $statement-&gt;get_result();
  check_errors($res);
  $product = $res-&gt;fetch_assoc();
  $statement-&gt;close();
  return $product;
}

function insert_product($name, $secret, $description) {
  global $db;
  $statement = $db-&gt;prepare(
    "INSERT INTO products (name, secret, description) VALUES
      (?, ?, ?)"
  );
  check_errors($statement);
  $statement-&gt;bind_param("sss", $name, $secret, $description);
  check_errors($statement-&gt;execute());
  $statement-&gt;close();
}

function check_name_secret($name, $secret) {
  global $db;
  $valid = false;
  $statement = $db-&gt;prepare(
    "SELECT name FROM products WHERE name = ? AND secret = ?"
  );
  check_errors($statement);
  $statement-&gt;bind_param("ss", $name, $secret);
  check_errors($statement-&gt;execute());
  $res = $statement-&gt;get_result();
  check_errors($res);
  if ($res-&gt;fetch_assoc() !== null) {
    $valid = true;
  }
  $statement-&gt;close();
  return $valid;
}
</code></pre>
</div>
<p>view.php</p>
<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php

require_once("db.php");
require_once("header.php");

function handle_post() {
  global $_POST;

  $name = $_POST["name"];
  $secret = $_POST["secret"];

  if (isset($name) &amp;&amp; $name !== ""
        &amp;&amp; isset($secret) &amp;&amp; $secret !== "") {
    if (check_name_secret($name, hash('sha256', $secret)) === false) {
      return "Incorrect name or secret, please try again";
    }

    $product = get_product($name);

    echo "&lt;p&gt;Product details:";
    echo "&lt;ul&gt;&lt;li&gt;" . htmlentities($product['name']) . "&lt;/li&gt;";
    echo "&lt;li&gt;" . htmlentities($product['description']) . "&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;";
  }

  return null;
}

$error = handle_post();
if ($error !== null) {
  echo "&lt;p&gt;Error: " . $error . "&lt;/p&gt;";
}
?&gt;
&lt;form action="/view.php" method="POST"&gt;
  Name: &lt;input type="text" name="name" /&gt;&lt;br /&gt;
  Secret: &lt;input type="password" name="secret" /&gt;&lt;br /&gt;
  &lt;input type="submit" value="View" /&gt;
&lt;/form&gt;

&lt;?php require_once("footer.php");
</code></pre>
</div>
<p>add.php</p>
<div class="highlighter-rouge"><pre class="highlight"><code>&lt;?php

require_once("db.php");
require_once("header.php");

function validate_secret($secret) {
  if (strlen($secret) &lt; 10) {
    return false;
  }
  $has_lowercase = false;
  $has_uppercase = false;
  $has_number = false;
  foreach (str_split($secret) as $ch) {
    if (ctype_lower($ch)) {
      $has_lowercase = true;
    } else if (ctype_upper($ch)) {
      $has_uppercase = true;
    } else if (is_numeric($ch)) {
      $has_number = true;
    }
  }
  return $has_lowercase &amp;&amp; $has_uppercase &amp;&amp; $has_number;
}

function handle_post() {
  global $_POST;

  $name = $_POST["name"];
  $secret = $_POST["secret"];
  $description = $_POST["description"];

  if (isset($name) &amp;&amp; $name !== ""
        &amp;&amp; isset($secret) &amp;&amp; $secret !== ""
        &amp;&amp; isset($description) &amp;&amp; $description !== "") {
    if (validate_secret($secret) === false) {
      return "Invalid secret, please check requirements";
    }

    $product = get_product($name);
    if ($product !== null) {
      return "Product name already exists, please enter again";
    }

    insert_product($name, hash('sha256', $secret), $description);

    echo "&lt;p&gt;Product has been added&lt;/p&gt;";
  }

  return null;
}

$error = handle_post();
if ($error !== null) {
  echo "&lt;p&gt;Error: " . $error . "&lt;/p&gt;";
}
?&gt;
&lt;form action="/add.php" method="POST"&gt;
  Name of your product: &lt;input type="text" name="name" /&gt;&lt;br /&gt;
  Secret (10+ characters, smallcase, uppercase, number) : &lt;input type="password" name="secret" /&gt;&lt;br /&gt;
  Description: &lt;input type="text" name="description" /&gt;&lt;br /&gt;
  &lt;input type="submit" value="Add" /&gt;
&lt;/form&gt;

&lt;?php require_once("footer.php");
</code></pre>
</div>

<p>Looking at the comments, there is information regarding where the flag is hidden.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/*
INSERT INTO products VALUES('facebook', sha256(....), 'FLAG_HERE');
INSERT INTO products VALUES('messenger', sha256(....), ....);
INSERT INTO products VALUES('instagram', sha256(....), ....);
INSERT INTO products VALUES('whatsapp', sha256(....), ....);
INSERT INTO products VALUES('oculus-rift', sha256(....), ....);
*/
</code></pre>
</div>
<p>It seems like the goal of this challenge is to read the description value of the facebook product. This could be possible through SQL injection or brute force of the secret value/field. Looking at the source code, prepared statements seems to be in use.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  $statement = $db-&gt;prepare(
    "SELECT name FROM products WHERE name = ? AND secret = ?"
  );
  check_errors($statement);
  $statement-&gt;bind_param("ss", $name, $secret);
</code></pre>
</div>
<p>Futhermore, the secret value is also hashed using SHA256 and compared to the one in the database. Looking at the source code, it also not possible to confuse the application by inserting the same product name since checks are in place.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    $product = get_product($name);
    if ($product !== null) {
      return "Product name already exists, please enter again";
    }

</code></pre>
</div>
<p>However the following code looks like an entry point</p>

<div class="highlighter-rouge"><pre class="highlight"><code>function get_product($name) {
  global $db;
  $statement = $db-&gt;prepare(
    "SELECT name, description FROM products WHERE name = ?"
  );
  check_errors($statement);
  $statement-&gt;bind_param("s", $name);
  check_errors($statement-&gt;execute());
  $res = $statement-&gt;get_result();
  check_errors($res);
  $product = $res-&gt;fetch_assoc();
  $statement-&gt;close();
  return $product;
}
</code></pre>
</div>
<p>Tracing the code to where it is being called (see below), the following can be deduced.The <code class="highlighter-rouge">check_name_secret</code> function checks if a product exists with the entered name and secret value. However, the <code class="highlighter-rouge">get_product function</code> only returns one row from the database by using the <code class="highlighter-rouge">name</code> parameter. As such, you could add another product called facebook with a secret and get the application program to return the first already creadted product found with the name facebook.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>function handle_post() {
  global $_POST;

  $name = $_POST["name"];
  $secret = $_POST["secret"];

  if (isset($name) &amp;&amp; $name !== ""
        &amp;&amp; isset($secret) &amp;&amp; $secret !== "") {
    if (check_name_secret($name, hash('sha256', $secret)) === false) {
      return "Incorrect name or secret, please try again";
    }

    $product = get_product($name);

    echo "&lt;p&gt;Product details:";
    echo "&lt;ul&gt;&lt;li&gt;" . htmlentities($product['name']) . "&lt;/li&gt;";
    echo "&lt;li&gt;" . htmlentities($product['description']) . "&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;";
  }

  return null;
}
</code></pre>
</div>
<p>This vulnerability could be exploited using a vulnerability similiar to SQL Truncation Attack. This is due to MySQL comparing values within taking into account trailing spaces. Here we will enter a product with spaces e.g. <code class="highlighter-rouge">facebook&lt;space&gt;</code> into the application which will be stored within the database. This will then become <code class="highlighter-rouge">facebook</code> when we try to view the product again due to the comparison issue and we can view the facebook product to acquire our flag.</p>

<p><img src="/assets/facebookctf/11.png" alt="alt text" title="image11" /></p>

<p>The flag can be seen below.</p>

<p><img src="/assets/facebookctf/12.png" alt="alt text" title="image12" /></p>

</article>





<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
      <a href="//twitter.com/share?text=Facebook+CTF+2019%3A+Products+Manager+Writeup&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fcapture_the_flag%2F2019%2F06%2F08%2F10_Facebook_CTF_product_manager.html&via=snoopysecurity"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
        <i class="fa fa-twitter-square fa-lg"></i>
      </a>
    
    
    
    
    
    
    
  
    
    
    
      <a href="//www.facebook.com/sharer.php?t=Facebook+CTF+2019%3A+Products+Manager+Writeup&u=http%3A%2F%2Fsnoopysecurity.github.io%2Fcapture_the_flag%2F2019%2F06%2F08%2F10_Facebook_CTF_product_manager.html"
        onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
      <a href="//www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fcapture_the_flag%2F2019%2F06%2F08%2F10_Facebook_CTF_product_manager.html"
        onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;">
        <i class="fa fa-linkedin-square fa-lg"></i>
      </a>
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
      <a href="//www.pinterest.com/pin/create/button/?description=Facebook+CTF+2019%3A+Products+Manager+Writeup&url=http%3A%2F%2Fsnoopysecurity.github.io%2Fcapture_the_flag%2F2019%2F06%2F08%2F10_Facebook_CTF_product_manager.html&media=http://snoopysecurity.github.io/assets/header_img.jpg"
        onclick="window.open(this.href, 'pinterest-share', 'width=550,height=255');return false;">
        <i class="fa fa-pinterest-square fa-lg"></i>
      </a>
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
</section>




</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">ðŸ’» | Blog</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">About</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:na">
            <i class="fa fa-envelope-o"></i>
            <span class="username">na</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://twitter.com/snoopysecurity" title="Follow me on Twitter">
              <i class="fa fa-twitter"></i>
              <span class="username">snoopysecurity</span>
            </a>
          </li>
          
        
          
        
          
          <li>
            <a href="https://github.com/snoopysecurity" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">snoopysecurity</span>
            </a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">Hacking to learn, while learning to hack.
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });
});

</script>






  </body>

</html>
