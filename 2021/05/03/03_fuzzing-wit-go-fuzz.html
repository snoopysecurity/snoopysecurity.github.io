<p>c—
layout: post
title:  “Fuzzing with Go-Fuzz”
date:   2021-05-03 09:00:00
author: snoopysecurity
categories: software-security
—</p>

<p>Fuzzing can often be a very useful technical for finding bugs. Go-fuzz is a coverage-guided fuzzing solution for testing of Go packages. <a href="https://github.com/dvyukov/go-fuzz">go-fuzz</a>. This blog post will walk you through how to use it to find bugs.</p>

<p><strong>1) Installing Go</strong></p>

<p>On linux, Go can be quickly installed by the following commands.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd /tmp
$ ls
$ curl -OL https://golang.org/dl/go1.15.12.linux-amd64.tar.gz
$ sudo tar -C /usr/local -xvf go1.15.12.linux-amd64.tar.gz
$ go version
</code></pre>
</div>

<p>2) <strong>Choosing a target</strong></p>

<p>Some easy ways to find a target for fuzzing can be</p>

<ul>
  <li>https://pkg.go.dev/</li>
  <li>https://github.com/trending/go</li>
  <li>https://github.com/avelino/awesome-go</li>
</ul>

<p>For this example, we will fuzz <a href="https://github.com/JoshVarga/svgparser">https://github.com/JoshVarga/svgparser</a></p>

<p>3) <strong>Building pdf package for fuzzing</strong></p>

<p>Go-fuzz can be installed by running the following commands</p>

<div class="highlighter-rouge"><pre class="highlight"><code>go get -u github.com/dvyukov/go-fuzz/go-fuzz
go get -u github.com/dvyukov/go-fuzz/go-fuzz-build
</code></pre>
</div>

<p>This installs the latest version of go-fuzz onto your go path</p>

<p>The svg target we are fuzzing can be installed by <code class="highlighter-rouge">go get -u github.com/JoshVarga/svgparser</code> which will install the svg reader onto your go path as well.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/home/snoopy/gowork/src/github.com/JoshVarga/svgparser
❯ ls
 example_test.go   find.go   find_test.go   fuzz.go   LICENSE   parser.go   parser_test.go   README.md   testutils_test.go   utils
❯ 
</code></pre>
</div>

<p>This will install the svg package we are fuzzing in our go path, you can now go to this directory and create a new file call <code class="highlighter-rouge">fuzz.go</code> which will contain your harness.</p>

<p>Within Svgparser, we will try to fuzz the <code class="highlighter-rouge">Parse</code> function</p>

<p><img src="/assets/gofuzz/1.png" alt="" /></p>

<p><a href="https://github.com/JoshVarga/svgparser/blob/5eaba627a7d11a384dde3802ac251442e14d87ef/parser.go#L121">https://github.com/JoshVarga/svgparser/blob/5eaba627a7d11a384dde3802ac251442e14d87ef/parser.go#L121</a></p>

<p>To fuzz this function, we can create a fuzz function harness for go-fuzz with the same package name. (Note: your fuzz.go file should be on the same folder as the function you are fuzzing). This function must return 1 if the fuzzer should increase priority of the given input during subsequent fuzzing (for example, the input is lexically correct and was parsed successfully); -1 if the input must not be added to corpus even if gives new coverage; and 0 otherwise; other values are reserved for future use. The Fuzz function must be in a package that go-fuzz can import. This means the code you want to test can’t be in package main. Fuzzing internal packages are also supported.</p>

<p>An examples fuzz function for fuzzing can be seen below (which is saved within <code class="highlighter-rouge">/home/snoopy/gowork/src/github.com/JoshVarga/svgparser</code>)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>package svgparser

import (
	"bytes"
)

func Fuzz(data []byte) int {

	element,err := Parse(bytes.NewReader(data), false)
	if err != nil {
		if element != nil {
			panic("svg != nil on error")
		}
		return 0
	}

	return 1

}
</code></pre>
</div>
<p>This implements <code class="highlighter-rouge">Fuzz(data []byte)</code> function, which is an API expected by go-fuzz. once this has been done, you can go back to your working directory and use <code class="highlighter-rouge">go-fuzz-build</code> to build the archive which <code class="highlighter-rouge">go-fuzz</code> will use.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>❯ pwd
/home/snoopy/svg_fuzz
❯ go-fuzz-build github.com/JoshVarga/svgparser
 ✗ ls
  svgparser-fuzz.zip
</code></pre>
</div>

<p>which will produce svgparser-fuzz.zip archive.</p>

<p>3) <strong>Building a corpus</strong></p>

<p>The next step is to build a corpus for gofuzz to use which will be placed within your working directory. Ideally, files in the corpus are as small as possible and as diverse as possible. You can use inputs used by unit tests, examples and/or generate them manually. Go-fuzz by default will deduplicate and minimize the inputs</p>

<p>Go-fuzz will also add own inputs to the corpus directory. Furthermore, the go-fuzz-corpus repository contains a bunch of examples of test functions and initial input corpuses for various packages. <a href="https://github.com/dvyukov/go-fuzz-corpus">https://github.com/dvyukov/go-fuzz-corpus</a>.</p>

<p>In this instance, example svg files can be taken from <a href="https://github.com/strongcourage/fuzzing-corpus">https://github.com/strongcourage/fuzzing-corpus</a></p>

<p>Another option would be to create an example svg file and use <a href="https://gitlab.com/akihe/radamsa">radamsa</a> to mutate the files to create some examples. Gofuzz will also mutate the files given and create more files for your corpus</p>

<p>These files can be taken and copied to a folder called corpus within you fuzzing directory.</p>

<p>3) <strong>Fuzzing</strong></p>

<p>going back to your working directory, you can now start gofuzz: <code class="highlighter-rouge">go-fuzz -bin=svgparser-fuzz.zip -workdir=.</code> The working directory here should contain a folder corpus with all the svg files your previous found.</p>

<p><img src="/assets/gofuzz/2.png" alt="" /></p>

<p>As long as you don’t delete working directory, you can stop and re-start go-fuzz and it will restart where it stopped. Found crashes will be logged in crashers directory.</p>

<ul>
  <li>*workers means number of tests running in parallel (set with -procs flag).</li>
  <li>corpus is current number of interesting inputs the fuzzer has discovered, time in brackets says when the last interesting input was discovered</li>
  <li>crashers is number of discovered bugs (check out workdir/crashers dir).</li>
  <li>restarts is the rate with which the fuzzer restarts test processes.</li>
  <li>cover is number of bits set in a hashed coverage bitmap</li>
</ul>

<p>4) <strong>Triaging Crashes</strong></p>

<p>For any unique crashes, these will be logged within your <code class="highlighter-rouge">crashers</code> directory.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>❯ cd crashers/
❯ ls
 0106e07494ad508ca0ec6e32d0ae9ac7bb932de7          4465097c05a30de5b06942b3f02e4e196276ae49          88ffb7f7327afe041ac722aaccc9b248b1a12524          c5f797d236f6199102cc91083335469aac76cece
 0106e07494ad508ca0ec6e32d0ae9ac7bb932de7.output   4465097c05a30de5b06942b3f02e4e196276ae49.output   88ffb7f7327afe041ac722aaccc9b248b1a12524.output   c5f797d236f6199102cc91083335469aac76cece.output
 0106e07494ad508ca0ec6e32d0ae9ac7bb932de7.quoted
</code></pre>
</div>

<p>These will be the format, fuzz input which is the input used to fuzz the file, the .quoted file contains the input quoted as a string and the .output file contains the crash dump</p>

<p>Example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>❯ cat 0106e07494ad508ca0ec6e32d0ae9ac7bb932de7
&lt;svg xmlns="htt00000000000000000000000"&gt;00&lt;/svg&gt;0
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>❯ cat 0106e07494ad508ca0ec6e32d0ae9ac7bb932de7.quoted 
	"&lt;svg xmlns=\"htt00000" +
	"000000000000000000\"&gt;" +
	"00&lt;/svg&gt;0"

</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>❯ cat 0106e07494ad508ca0ec6e32d0ae9ac7bb932de7.output 
SVG width: panic: runtime error: index out of range [0] with length 0
</code></pre>
</div>
<p>This can then be triaged by creating a small program with the input, and using a go debugger to see the stack properly and what part of the code is crashing.</p>

<h3 id="further-reading">Further Reading</h3>

<ul>
  <li>
    <p><a href="https://parsiya.net/blog/2018-04-29-learning-go-fuzz-1-iprange/">Learning Go-Fuzz 1: iprange</a></p>
  </li>
  <li>
    <p><a href="https://parsiya.net/blog/2018-05-05-learning-go-fuzz-2-goexif2/">Learning Go-Fuzz 2: goexif2</a></p>
  </li>
  <li>
    <p><a href="https://mijailovic.net/2017/07/29/go-fuzz/">Going down the rabbit hole with go-fuzz</a></p>
  </li>
</ul>
